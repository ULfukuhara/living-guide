<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入居直後アンケート | UNIV LIFE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .rating label { cursor: pointer; }
    .rating input { transform: scale(1.15); margin-right: 8px; }
    .stars {
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-sm p-6 space-y-5">
    <p id="metaLine" class="text-[10px] text-slate-400"></p>

    <div id="errorLine" class="hidden rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"></div>

    <!-- ✅ 送信完了（初回/再送共通） -->
    <div id="thanksBox" class="hidden space-y-3 text-center">
      <p class="text-sm text-emerald-700 font-semibold" id="thanksTitle">
        ✅ アンケートを受け付けました
      </p>
      <p class="text-xs text-slate-500" id="thanksBody">
        ご協力ありがとうございます。内容はサービス改善に活用します。
      </p>

      <div class="rounded-lg border bg-slate-50 px-3 py-2 text-left">
        <div class="text-[11px] text-slate-500">受付日時</div>
        <div id="thanksAt" class="text-sm font-semibold text-slate-800"></div>
      </div>

      <button id="againBtn"
        class="w-full rounded-lg border px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
        もう一度入力する
      </button>
    </div>

    <!-- 回答済み表示（再送可能を明確化） -->
    <div id="answeredBox" class="hidden space-y-4 text-center">
      <p class="text-sm text-emerald-700 font-semibold">
        ✅ このアンケートはすでにご回答いただいています
      </p>
      <p class="text-xs text-slate-500">
        再度入力しても送信できます。<br/>
        送信後に「受付完了（日時）」を表示します。
      </p>
      <button id="retryBtn"
        class="w-full rounded-lg border px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
        追加で回答する
      </button>
    </div>

    <!-- フォーム -->
    <form id="surveyForm" class="hidden space-y-6">
      <div class="space-y-1">
        <h1 class="text-base font-semibold text-slate-800">
          ご入居後のご感想を教えてください
        </h1>
        <p class="text-xs text-slate-500">所要時間：1分程度</p>
      </div>

      <!-- Q1 -->
      <div>
        <p class="text-sm font-medium">① お部屋の状態はいかがでしたか？</p>
        <div class="rating mt-2 space-y-2 text-sm">
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="5">
            <span class="stars">★★★★★</span><span class="ml-2">とても満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="4">
            <span class="stars">★★★★☆</span><span class="ml-2">満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="3">
            <span class="stars">★★★☆☆</span><span class="ml-2">ふつう</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="2">
            <span class="stars">★★☆☆☆</span><span class="ml-2">やや不満</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="1">
            <span class="stars">★☆☆☆☆</span><span class="ml-2">不満</span>
          </label>
        </div>
      </div>

      <!-- Q2 -->
      <div>
        <p class="text-sm font-medium">② お部屋探し（仲介）はいかがでしたか？</p>
        <div class="rating mt-2 space-y-2 text-sm">
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="5">
            <span class="stars">★★★★★</span><span class="ml-2">とても満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="4">
            <span class="stars">★★★★☆</span><span class="ml-2">満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="3">
            <span class="stars">★★★☆☆</span><span class="ml-2">ふつう</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="2">
            <span class="stars">★★☆☆☆</span><span class="ml-2">やや不満</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="1">
            <span class="stars">★☆☆☆☆</span><span class="ml-2">不満</span>
          </label>
        </div>
      </div>

      <!-- Q3 -->
      <div>
        <p class="text-sm font-medium">③ 管理会社の対応や入居のしおりは分かりやすかったですか？</p>
        <div class="rating mt-2 space-y-2 text-sm">
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="5">
            <span class="stars">★★★★★</span><span class="ml-2">とても満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="4">
            <span class="stars">★★★★☆</span><span class="ml-2">満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="3">
            <span class="stars">★★★☆☆</span><span class="ml-2">ふつう</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="2">
            <span class="stars">★★☆☆☆</span><span class="ml-2">やや不満</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="1">
            <span class="stars">★☆☆☆☆</span><span class="ml-2">不満</span>
          </label>
        </div>
      </div>

      <!-- Q4 -->
      <div>
        <p class="text-sm font-medium">④ 気になった点・ご要望があれば教えてください（任意）</p>
        <textarea id="comment"
          class="mt-2 w-full rounded-lg border border-slate-300 p-2 text-sm"
          rows="3"
          placeholder="例）しおりの○○が分かりにくかった／設備の△△が気になる など"></textarea>
      </div>

      <button type="button" id="submitBtn"
        class="w-full rounded-lg bg-emerald-600 text-white py-2 text-sm font-semibold hover:bg-emerald-700">
        送信
      </button>

      <p class="text-[11px] text-slate-400">※ 送信内容はサービス改善の目的で利用します。</p>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDneH08GavPizbtH4Oi-RsTrwGerxXWSyQ",
      authDomain: "univlife-kanri.firebaseapp.com",
      projectId: "univlife-kanri",
      storageBucket: "univlife-kanri.firebasestorage.app",
      messagingSenderId: "405011982427",
      appId: "1:405011982427:web:cf56a37550ab714bfdb77e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const url = new URL(window.location.href);
    const token = (url.searchParams.get("token") || "").trim();
    const propertyNo = (url.searchParams.get("propertyNo") || "").trim();
    const source = (url.searchParams.get("source") || "unknown").trim();

    function showError(msg) {
      const el = document.getElementById("errorLine");
      el.textContent = msg;
      el.classList.remove("hidden");
    }
    function clearError() {
      const el = document.getElementById("errorLine");
      el.classList.add("hidden");
      el.textContent = "";
    }

    function getScore(name) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? Number(el.value) : null;
    }

    async function checkAnsweredByToken() {
      const q1 = query(collection(db, "movein_survey"), where("token", "==", token), limit(1));
      const snap = await getDocs(q1);
      return !snap.empty;
    }

    function localKey() {
      return `movein_survey_answered_${propertyNo || "unknown"}`;
    }
    function checkAnsweredLocal() {
      try { return localStorage.getItem(localKey()) === "1"; } catch { return false; }
    }
    function markAnsweredLocal() {
      try { localStorage.setItem(localKey(), "1"); } catch {}
    }

    function showAnswered() {
      document.getElementById("surveyForm").classList.add("hidden");
      document.getElementById("thanksBox").classList.add("hidden");
      document.getElementById("answeredBox").classList.remove("hidden");
    }
    function showForm() {
      document.getElementById("answeredBox").classList.add("hidden");
      document.getElementById("thanksBox").classList.add("hidden");
      document.getElementById("surveyForm").classList.remove("hidden");
      clearError();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showThanks({ isResubmit }) {
      document.getElementById("surveyForm").classList.add("hidden");
      document.getElementById("answeredBox").classList.add("hidden");
      document.getElementById("thanksBox").classList.remove("hidden");

      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");

      document.getElementById("thanksAt").textContent = `${y}/${m}/${d} ${hh}:${mm}`;

      // ✅ 再送であることが明確に分かる表示
      if (isResubmit) {
        document.getElementById("thanksTitle").textContent = "✅ 追加の回答（再送信）を受け付けました";
        document.getElementById("thanksBody").textContent =
          "再度のご協力ありがとうございます。内容はサービス改善に活用します。";
      } else {
        document.getElementById("thanksTitle").textContent = "✅ アンケートを受け付けました";
        document.getElementById("thanksBody").textContent =
          "ご協力ありがとうございます。内容はサービス改善に活用します。";
      }

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function submitSurvey() {
      clearError();

      if (getScore("room") === null || getScore("broker") === null || getScore("management") === null) {
        showError("①〜③は選択してください。");
        return;
      }

      // 「すでに回答済み」だったか（再送かどうか）を送信前に判定
      let wasAnswered = false;
      try {
        if (token) {
          wasAnswered = await checkAnsweredByToken();
        } else {
          wasAnswered = checkAnsweredLocal();
        }
      } catch {}

      const data = {
        token: token || null,
        propertyNo: propertyNo || null,
        source,
        room_score: getScore("room"),
        broker_score: getScore("broker"),
        management_score: getScore("management"),
        comment: document.getElementById("comment").value || "",
        created_at: serverTimestamp(),
        user_agent: navigator.userAgent,
        resubmitted: wasAnswered ? true : false // ★再送フラグ（分析に便利）
      };

      // 送信中の二重押し防止
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = "送信中…";

      try {
        await addDoc(collection(db, "movein_survey"), data);

        // 公開URL（tokenなし）だけ localStorage に記録
        if (!token) markAnsweredLocal();

        // ✅ ここで「再送できた」ことを明確に表示
        showThanks({ isResubmit: wasAnswered });
      } catch (e) {
        console.error(e);
        showError("送信に失敗しました。時間をおいて再度お試しください。");
      } finally {
        btn.disabled = false;
        btn.textContent = prevText;
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const metaParts = [];
      if (token) metaParts.push("tokenあり");
      if (propertyNo) metaParts.push(`物件No: ${propertyNo}`);
      metaParts.push(`source: ${source}`);
      document.getElementById("metaLine").textContent = metaParts.join(" / ");

      if (!token && !propertyNo) {
        showError("URLに ?propertyNo=XXXX もしくは ?token=XXXX を付けてください。");
        showForm();
        return;
      }

      try {
        if (token) {
          const answered = await checkAnsweredByToken();
          answered ? showAnswered() : showForm();
        } else {
          checkAnsweredLocal() ? showAnswered() : showForm();
        }
      } catch (e) {
        console.error(e);
        showForm();
      }

      document.getElementById("retryBtn").addEventListener("click", showForm);
      document.getElementById("againBtn").addEventListener("click", showForm);
      document.getElementById("submitBtn").addEventListener("click", submitSurvey);
    });
  </script>
</body>
</html>
