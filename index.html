<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å…¥å±…ã®ã—ãŠã‚Š | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .richtext p { margin-bottom: 0.6rem; }
    .richtext ul { margin-left: 1.4rem; margin-bottom: 0.6rem; list-style: disc; }
    .richtext ol { margin-left: 1.4rem; margin-bottom: 0.6rem; list-style: decimal; }
    .richtext a { text-decoration: underline; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">
          UL
        </span>
        <div>
          <p class="text-xs text-slate-500">UNIV LIFE å…¥å±…è€…å°‚ç”¨</p>
          <h1 class="text-base sm:text-lg font-semibold text-slate-800" id="propertyTitle">
            ç‰©ä»¶åã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
          </h1>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-4 pt-4 pb-12 space-y-6">

      <!-- Property Meta -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 space-y-2">
        <p id="propertyMeta" class="text-[11px] text-slate-400">æƒ…å ±ã‚’å–å¾—ä¸­</p>
        <p class="text-[11px] text-slate-400">â€» å†…å®¹ã¯ç‰©ä»¶ã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™</p>
      </section>

      <!-- Tabs -->
      <section>
        <div id="tabNav" class="flex gap-2 overflow-x-auto pb-1 text-sm"></div>
        <div id="tabPanels" class="mt-3 space-y-4"></div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-200 bg-white">
    <div class="max-w-4xl mx-auto px-4 py-3 text-[11px] text-slate-400 flex justify-between">
      <p>Â© UNIV LIFE</p>
      <p>Storyblok + Firestore Living Guide</p>
    </div>
  </footer>

  <!-- ======================================================= -->
  <!-- JS: Storyblok + Firestore é€£æºï¼ˆmoduleï¼‰                -->
  <!-- ======================================================= -->
  <script type="module">
    // ==============================
    // è¨­å®š
    // ==============================
    const STORYBLOK_TOKEN = "sdvg2FfGE4TIQ6wTLIJItQtt";  // ã‚ãªãŸã® Public Token

    // â˜… ã“ã“ã‚’ã‚ãªãŸã® Firebase è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ â˜…
  const firebaseConfig = {
    apiKey: "AIzaSyDneH08GavPizbtH4Oi-RsTrwGerxXWSyQ",
    authDomain: "univlife-kanri.firebaseapp.com",
    projectId: "univlife-kanri",
    storageBucket: "univlife-kanri.firebasestorage.app",
    messagingSenderId: "405011982427",
    appId: "1:405011982427:web:cf56a37550ab714bfdb77e",
    measurementId: "G-DXMR0VL972"
  };
    // ------------------------------


  // Firestore ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ Section ã‚­ãƒ¼ä¸€è¦§ï¼ˆãã®ã¾ã¾ã§OKï¼‰
  const SECTION_KEYS = [
    "key",
    "mailbox",
    "delivery_box",
    "bicycle_space",
    "room_equipment",
    "special_note",
    "moving",
    "electricity",
    "gas",
    "water",
    "internet",
    "trash",
    "common_area",
    "pets",
    "toilet",
    "noise",
    "drainage",
    "ventilation",
    "heater",
    "bike_parking",
    "car_parking",
    "sales",
    "expenses",
    "cancellation",
  ];

  // ã‚«ãƒ†ã‚´ãƒªå®šç¾©ï¼ˆã‚¿ãƒ–åã¨ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
  const CATEGORY_DEFS = {
    basic:   { label: "ç”Ÿæ´»ã®åŸºæœ¬",     icon: "ğŸ " },
    trouble: { label: "ãƒˆãƒ©ãƒ–ãƒ«ãƒ»è¨­å‚™", icon: "ğŸ”§" },
    contract:{ label: "å¥‘ç´„ãƒ»è²»ç”¨",     icon: "ğŸ’°" },
    parking: { label: "é§è¼ªãƒ»é§è»Š",     icon: "ğŸš²" },
    other:   { label: "ãã®ä»–",         icon: "ğŸ“˜" }
  };


    // ==============================
    // Firebase åˆæœŸåŒ–
    // ==============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    let db = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firestore åˆæœŸåŒ– OK");
    } catch (e) {
      console.error("Firestore åˆæœŸåŒ–ã«å¤±æ•—:", e);
      db = null; // Firestore ãªã—ã§ Storyblok ã®ã¿å‹•ä½œ
    }

    // ==============================
    // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==============================
    function getPropertyNoFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("propertyNo") || "";
    }

    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ==============================
    // Storyblok API
    // ==============================
    async function fetchGuideStoryBySlug(slug) {
      const base = "https://api.storyblok.com/v2/cdn/stories";

      // â‘  å®Œå…¨ä¸€è‡´
      let url = `${base}/${encodeURIComponent(slug)}?token=${encodeURIComponent(
        STORYBLOK_TOKEN
      )}&version=published`;

      let res = await fetch(url);
      if (res.ok) {
        const data = await res.json();
        return data.story;
      }

      // â‘¡ å‰æ–¹ä¸€è‡´
      url = `${base}?token=${encodeURIComponent(
        STORYBLOK_TOKEN
      )}&version=published&starts_with=${encodeURIComponent(slug)}`;

      res = await fetch(url);
      if (!res.ok) {
        throw new Error("Storyblok API Error: " + res.status);
      }
      const data = await res.json();
      if (!data.stories || data.stories.length === 0) {
        throw new Error("Story not found for slug=" + slug);
      }
      return data.stories[0];
    }

    // ==============================
    // Firestore èª­ã¿å–ã‚Š
    // ==============================
    async function fetchPropertyConfig(propertyNo) {
      if (!db) return null;
      if (!propertyNo) return null;

      const ref = doc(db, "properties_shiori", propertyNo);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        console.warn("properties_shiori æœªç™»éŒ²:", propertyNo);
        return null;
      }
      return snap.data();
    }

    async function fetchGuidesMasterRaw() {
      if (!db) return [];
      const colRef = collection(db, "guides_master_raw");
      const snap = await getDocs(colRef);
      const list = [];
      snap.forEach((d) => {
        const data = d.data();
        list.push({
          section_key: data.section_key || "",
          variant_key: data.variant_key || "base",
          body_text: data.body_text || "",
        });
      });
      return list;
    }

    // Firestore ãƒ•ãƒ©ã‚°ã‚’ boolean ã«
    function buildSectionFlags(propData) {
      if (!propData) return null;

      const flags = {};
      SECTION_KEYS.forEach((key) => {
        const v = propData[key];
        // true / 1 / "TRUE" / "true" ã‚’ true ã¨åˆ¤å®š
        const b =
          v === true ||
          v === 1 ||
          v === "1" ||
          (typeof v === "string" && v.toLowerCase() === "true");
        flags[key] = b;
      });
      return flags;
    }

    // variant ã«å¿œã˜ã¦æœ¬æ–‡ã‚’é¸ã¶
    function pickBodyText(masterList, sectionKey, variantKey) {
      if (!masterList || masterList.length === 0) return "";

      // 1. variantKey æŒ‡å®š
      let hit = masterList.find(
        (row) =>
          row.section_key === sectionKey && row.variant_key === variantKey
      );
      if (hit && hit.body_text) return hit.body_text;

      // 2. base ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      hit = masterList.find(
        (row) =>
          row.section_key === sectionKey && row.variant_key === "base"
      );
      if (hit && hit.body_text) return hit.body_text;

      return "";
    }

    // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆbody_textï¼‰ã‚’ç°¡æ˜“HTMLã«
    function renderPlainTextAsHtml(text) {
      if (!text) return "";
      const escaped = escapeHtml(text);
      // URL ã£ã½ã„ã¨ã“ã‚ã‚’ãƒªãƒ³ã‚¯åŒ–ï¼ˆé›‘ã« http ã‹ã‚‰ç©ºç™½ã¾ã§ï¼‰
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const withLinks = escaped.replace(
        urlRegex,
        '<a href="$1" target="_blank" rel="noopener" class="text-sky-600 underline">$1</a>'
      );
      // æ”¹è¡Œ â†’ <br>
      return withLinks.replace(/\r?\n/g, "<br />");
    }

    // Storyblok Richtextï¼ˆä¿é™ºã¨ã—ã¦æ®‹ã™ï¼‰
    function renderRichText(node) {
      if (!node || !node.content) return "";
      return node.content
        .map((c) => {
          switch (c.type) {
            case "paragraph":
              return `<p>${(c.content || [])
                .map((n) => {
                  if (n.type === "text") {
                    let t = escapeHtml(n.text || "");
                    if (n.marks) {
                      n.marks.forEach((m) => {
                        if (m.type === "bold") t = `<strong>${t}</strong>`;
                        if (m.type === "italic") t = `<em>${t}</em>`;
                      });
                    }
                    return t;
                  }
                  if (n.type === "hard_break") return "<br />";
                  return "";
                })
                .join("")}</p>`;
            default:
              return "";
          }
        })
        .join("");
    }

    // ==============================
    // ãƒšãƒ¼ã‚¸æç”»
    // ==============================
    function renderGuidePage(story, options) {
      const { propertyData, sectionFlags, masterList, variantKey } = options;

      const content = story.content || {};
      const sections = content.sections || [];

      // ã‚¿ã‚¤ãƒˆãƒ«
      document.getElementById("propertyTitle").textContent =
        content.title || story.name || "å…¥å±…ã®ã—ãŠã‚Š";

      // Meta
      const meta = document.getElementById("propertyMeta");
      if (propertyData) {
        const parts = [];
        if (propertyData.propertyNo) parts.push(`ç‰©ä»¶No. ${propertyData.propertyNo}`);
        if (propertyData.canonicalName) parts.push(propertyData.canonicalName);
        if (propertyData.address) parts.push(propertyData.address);
        meta.textContent = parts.join(" ï½œ ");
      } else {
        meta.textContent = content.propertyNo
          ? `ç‰©ä»¶No. ${content.propertyNo}`
          : "";
      }

      const tabNav = document.getElementById("tabNav");
      const tabPanels = document.getElementById("tabPanels");

      tabNav.innerHTML = "";
      tabPanels.innerHTML = "";

      // ã—ãŠã‚Šå…¨ä½“ã®å…¬é–‹åˆ¤å®š
      if (propertyData && propertyData.shiori_enabled === false) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šã¯æº–å‚™ä¸­ã§ã™ã€‚</p>';
        return;
      }

      if (!sections.length) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šã¯æº–å‚™ä¸­ã§ã™ã€‚</p>';
        return;
      }

      // ===== 1) ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚£ãƒ«ã‚¿ & ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ =====
      const grouped = {}; // {categoryKey: [section, ...]}
      sections.forEach((sec, idx) => {
        const key = sec.key || sec._uid || `sec${idx}`;

        // Firestore ãƒ•ãƒ©ã‚°ã§è¡¨ç¤º/éè¡¨ç¤ºã‚’æ±ºå®šï¼ˆãªã‘ã‚Œã° show_tab ã‚’ä½¿ã†ï¼‰
        let show = true;
        if (sectionFlags && key in sectionFlags) {
          show = sectionFlags[key];
        } else if (sec.show_tab === false) {
          show = false;
        }
        if (!show) return;

        const cat = sec.category || "basic";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ sec, key });
      });

      const categoryKeys = Object.keys(grouped);
      if (!categoryKeys.length) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªé †ã‚’æƒãˆã‚‹ï¼ˆå®šç¾©é †ã§ä¸¦ã¹ã‚‹ï¼‰
      const orderedCategoryKeys = Object.keys(CATEGORY_DEFS).filter((k) =>
        categoryKeys.includes(k)
      );

      // ===== 2) ã‚¿ãƒ–ã¨ãƒ‘ãƒãƒ«ã‚’ã‚«ãƒ†ã‚´ãƒªå˜ä½ã§ä½œæˆ =====
      orderedCategoryKeys.forEach((catKey, idx) => {
        const def = CATEGORY_DEFS[catKey] || {
          label: catKey,
          icon: ""
        };
        const catLabel = def.label;
        const catIcon = def.icon || "";

        const isActive = idx === 0;

        // â–¼ ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.tab = catKey;
        btn.className =
          "tab-btn px-3 py-1.5 rounded-full whitespace-nowrap text-xs sm:text-sm " +
          (isActive ? "bg-slate-900 text-white" : "bg-slate-100 text-slate-700");
        btn.innerHTML =
          (catIcon ? `<span>${catIcon}</span> ` : "") +
          `<span>${escapeHtml(catLabel)}</span>`;
        tabNav.appendChild(btn);

        // â–¼ ãƒ‘ãƒãƒ«ï¼ˆã‚«ãƒ†ã‚´ãƒªå†…ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰ï¼‹ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã§è¡¨ç¤ºï¼‰
        const panel = document.createElement("section");
        panel.dataset.tabPanel = catKey;
        panel.className =
          "tab-panel space-y-3 " + (isActive ? "" : "hidden");

        const sectionsInCat = grouped[catKey];

        const cardsHtml = sectionsInCat
          .map(({ sec, key }) => {
            const title = sec.title || "ã‚»ã‚¯ã‚·ãƒ§ãƒ³";
            const icon = sec.icon || "";

            // æœ¬æ–‡ï¼šFirestore ãƒã‚¹ã‚¿å„ªå…ˆ
            const textFromMaster = pickBodyText(masterList, key, variantKey);
            const bodyHtml = textFromMaster
              ? renderPlainTextAsHtml(textFromMaster)
              : renderRichText(sec.body);

            const summary = sec.summary || "";

            return `
              <article class="bg-white rounded-2xl shadow-sm border border-slate-100">
                <details class="group">
                  <summary class="flex items-center justify-between gap-3 px-4 py-3 sm:px-5 cursor-pointer">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        ${icon ? `<span class="text-lg">${icon}</span>` : ""}
                        <h3 class="text-sm sm:text-base font-semibold text-slate-900 truncate">
                          ${escapeHtml(title)}
                        </h3>
                      </div>
                      ${
                        summary
                          ? `<p class="mt-0.5 text-[11px] sm:text-xs text-slate-500 line-clamp-2">${escapeHtml(
                              summary
                            )}</p>`
                          : ""
                      }
                    </div>
                    <span class="ml-2 text-slate-400 group-open:rotate-180 transition-transform">
                      â–¼
                    </span>
                  </summary>
                  <div class="px-4 pb-4 sm:px-5 sm:pb-5 border-t border-slate-100">
                    <div class="richtext mt-3 text-xs sm:text-sm text-slate-700 leading-relaxed">
                      ${bodyHtml}
                    </div>
                  </div>
                </details>
              </article>
            `;
          })
          .join("");

        panel.innerHTML = cardsHtml;
        tabPanels.appendChild(panel);
      });

      setupTabs();
    }


    function setupTabs() {
      const tabBtns = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;

          tabBtns.forEach((b) => {
            const active = b === btn;
            b.classList.toggle("bg-slate-900", active);
            b.classList.toggle("text-white", active);
            b.classList.toggle("bg-slate-100", !active);
            b.classList.toggle("text-slate-700", !active);
          });

          panels.forEach((p) => {
            p.classList.toggle("hidden", p.dataset.tabPanel !== target);
          });

          const firstPanel = panels[0];
          if (firstPanel) {
            const top =
              window.scrollY + firstPanel.getBoundingClientRect().top - 80;
            window.scrollTo({ top, behavior: "smooth" });
          }
        });
      });
    }

    // ==============================
    // ãƒ¡ã‚¤ãƒ³
    // ==============================
    async function main() {
      const propertyNo = getPropertyNoFromUrl();
      const tabPanels = document.getElementById("tabPanels");

      if (!propertyNo) {
        tabPanels.innerHTML =
          '<p class="text-sm text-rose-600">URL ã« ?propertyNo=XXXX ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>';
        return;
      }

      let propertyData = null;
      let masterList = [];
      let sectionFlags = null;
      let variantKey = "base";
      let slug = propertyNo;

      // Firestore ã‹ã‚‰è¨­å®šã‚’å–å¾—ï¼ˆå¤±æ•—ã—ã¦ã‚‚ Storyblok ã ã‘ã§å‹•ãï¼‰
      if (db) {
        try {
          [propertyData, masterList] = await Promise.all([
            fetchPropertyConfig(propertyNo),
            fetchGuidesMasterRaw(),
          ]);

          if (propertyData) {
            slug = propertyData.shiori_slug || propertyNo;
            variantKey = propertyData.variant_key || "base";
            sectionFlags = buildSectionFlags(propertyData);
          }
        } catch (e) {
          console.error("Firestore èª­ã¿å–ã‚Šä¸­ã«ã‚¨ãƒ©ãƒ¼:", e);
        }
      }

      try {
        const story = await fetchGuideStoryBySlug(slug);
        renderGuidePage(story, {
          propertyData,
          sectionFlags,
          masterList,
          variantKey,
        });
      } catch (e) {
        console.error(e);
        tabPanels.innerHTML =
          '<p class="text-sm text-rose-600">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    document.addEventListener("DOMContentLoaded", main);
  </script>

</body>
</html>
