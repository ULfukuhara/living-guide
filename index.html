<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入居のしおり | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 id="propertyTitle" class="text-lg font-semibold text-slate-800">
          入居のしおりを読み込み中…
        </h1>
        <p id="propertyNo" class="text-xs text-slate-500"></p>
      </div>
      <span class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
        入居のしおり
      </span>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6 space-y-4">

      <!-- 状態表示 / デバッグ -->
      <div class="text-xs text-slate-500 space-y-1">
        <p id="statusMessage">Storyblok からデータを読み込んでいます…</p>
        <p id="debugUrl" class="break-all"></p>
        <p id="debugStatus" class="break-all text-red-600"></p>
      </div>

      <hr class="border-slate-200" />

      <!-- sections を描画する場所 -->
      <div id="guideBody" class="space-y-4"></div>

      <!-- 生の JSON を確認したくなったとき用（小さく表示） -->
      <pre id="debugJson" class="text-[10px] text-slate-400 whitespace-pre-wrap bg-slate-100 rounded p-2 overflow-x-auto"></pre>
    </div>
  </main>

  <footer class="border-t border-slate-200 bg-white">
    <div class="max-w-3xl mx-auto px-4 py-3">
      <p class="text-[10px] text-slate-400">© ユニヴ・ライフ株式会社 管理部</p>
    </div>
  </footer>

  <script>
    // ==============================
    // 設定（★ここだけ必ず確認）
    // ==============================

    // ★ Preview（紫）のトークンを入れてください
    const STORYBLOK_TOKEN   = "ir2Hm2c38mI69te9Vr92RAtt";
    // ★ Preview トークンを使うので draft 固定
    const STORYBLOK_VERSION = "draft";

    const statusEl = document.getElementById("statusMessage");
    const urlEl    = document.getElementById("debugUrl");
    const statEl   = document.getElementById("debugStatus");
    const jsonEl   = document.getElementById("debugJson");
    const titleEl  = document.getElementById("propertyTitle");
    const noEl     = document.getElementById("propertyNo");
    const bodyEl   = document.getElementById("guideBody");

    // ==============================
    // URL から propertyNo を取得
    // ==============================
    function getPropertyNoFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get("propertyNo") || "10100"; // デフォルト 10100
      return raw.toString().trim();
    }

    const propertyNo = getPropertyNoFromUrl();
    noEl.textContent = `物件No：${propertyNo}`;

    // ==============================
    // Storyblok から Story を取得
    // ==============================
    async function loadGuide(propertyNo) {
      const slug = propertyNo; // full_slug が "10100" なのでそのまま

      const apiUrl =
        "https://api.storyblok.com/v2/cdn/stories/" +
        encodeURIComponent(slug) +
        `?token=${STORYBLOK_TOKEN}&version=${STORYBLOK_VERSION}`;

      urlEl.textContent = `API URL: ${apiUrl}`;

      try {
        const res = await fetch(apiUrl);
        statEl.textContent = `HTTP status: ${res.status} ${res.statusText}`;

        const text = await res.text();       // 生テキスト
        jsonEl.textContent = text;           // そのまま表示（成功でもエラーでも）

        if (!res.ok) {
          statusEl.textContent = "入居のしおりの読み込みに失敗しました。（HTTP エラー）";
          bodyEl.innerHTML =
            '<p class="text-sm text-red-600">お手数ですが、管理会社までご連絡ください。</p>';
          return;
        }

        const data = JSON.parse(text);
        const story = data.story;
        if (!story || !story.content) {
          statusEl.textContent = "ストーリーの内容が見つかりません。";
          bodyEl.innerHTML =
            '<p class="text-sm text-slate-500">入居のしおりの内容がまだ登録されていません。</p>';
          return;
        }

        const content = story.content;

        // タイトル更新
        titleEl.textContent =
          content.title || story.name || `入居のしおり（${propertyNo}）`;

        // sections 描画
        renderSections(content.sections || []);

        statusEl.textContent = "最新のデータを表示しています。";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "入居のしおりの読み込みに失敗しました。（JavaScript エラー）";
        statEl.textContent += " / JS Error: " + String(err);
        bodyEl.innerHTML =
          '<p class="text-sm text-red-600">お手数ですが、管理会社までご連絡ください。</p>';
      }
    }

    // ==============================
    // sections を描画
    // ==============================
    function renderSections(sections) {
      bodyEl.innerHTML = "";

      if (!sections.length) {
        bodyEl.innerHTML =
          '<p class="text-sm text-slate-500">入居のしおりの内容がまだ登録されていません。</p>';
        return;
      }

      sections.forEach((section) => {
        if (!section) return;

        const wrapper = document.createElement("section");
        wrapper.className =
          "bg-white rounded-xl shadow-sm border border-slate-100 px-4 py-3 space-y-2";

        const h2 = document.createElement("h2");
        h2.className = "text-sm font-semibold text-slate-800";
        h2.textContent = section.headline || "";
        wrapper.appendChild(h2);

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "text-sm text-slate-700 whitespace-pre-line";
        bodyDiv.textContent = richtextToPlainText(section.body);
        wrapper.appendChild(bodyDiv);

        bodyEl.appendChild(wrapper);
      });
    }

    // ==============================
    // Richtext → プレーンテキスト
    // ==============================
    function richtextToPlainText(rich) {
      if (!rich || !Array.isArray(rich.content)) return "";
      const lines = [];

      rich.content.forEach((node) => {
        if (node.type === "paragraph" && Array.isArray(node.content)) {
          const line = node.content
            .map((child) => (child.text ? child.text : ""))
            .join("");
          if (line.trim() !== "") {
            lines.push(line);
          }
        }
      });

      return lines.join("\n\n");
    }

    // 実行
    loadGuide(propertyNo);
  </script>
</body>
</html>
