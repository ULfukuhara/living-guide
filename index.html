<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å…¥å±…ã®ã—ãŠã‚Šï½œãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- âœ… TOPç”¨ï¼šdescriptionï¼ˆå…¥å£ãƒšãƒ¼ã‚¸ã®SEOï¼‰ -->
  <meta name="description"
    content="ãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾ãŒç®¡ç†ã™ã‚‹è³ƒè²¸ç‰©ä»¶ã®å…¥å±…è€…å‘ã‘Webå…¥å±…ã®ã—ãŠã‚Šã§ã™ã€‚ã‚´ãƒŸå‡ºã—æ–¹æ³•ã€è¨­å‚™æ¡ˆå†…ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆåˆ©ç”¨æ–¹æ³•ã€ç”Ÿæ´»ãƒ«ãƒ¼ãƒ«ãªã©ã‚’ç‰©ä»¶ã”ã¨ã«æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚" />
  <link rel="canonical" href="https://guide.univ-life.com/" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .richtext p { margin-bottom: 0.6rem; }
    .richtext ul { margin-left: 1.4rem; margin-bottom: 0.6rem; list-style: disc; }
    .richtext ol { margin-left: 1.4rem; margin-bottom: 0.6rem; list-style: decimal; }
    .richtext a { text-decoration: underline; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LKMYKG189C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LKMYKG189C');
  </script>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">
          UL
        </span>
        <div>
          <p class="text-xs text-slate-500">UNIV LIFE å…¥å±…è€…å°‚ç”¨</p>
          <h1 class="text-base sm:text-lg font-semibold text-slate-800" id="propertyTitle">
            å…¥å±…ã®ã—ãŠã‚Šï¼ˆWebï¼‰
          </h1>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-4 pt-4 pb-12 space-y-6">

      <!-- â–¼ éƒ¨å±‹å°‚ç”¨ã²ã¿ã¤æƒ…å ±ã‚«ãƒ¼ãƒ‰ï¼ˆtoken ãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
      <section id="roomSecretSection" class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-[11px] font-medium text-emerald-600">ã“ã®ãŠéƒ¨å±‹å°‚ç”¨ã®ã”æ¡ˆå†…</p>
            <p id="roomSecretTitle" class="mt-1 text-sm sm:text-base font-semibold text-slate-800"></p>
            <p class="mt-1 text-[11px] text-slate-400">
              é›†åˆãƒã‚¹ãƒˆã®é–‹éŒ ç•ªå·ãªã©ã€ã“ã®ãŠéƒ¨å±‹ã«å›ºæœ‰ã®æƒ…å ±ã§ã™ã€‚
            </p>
          </div>
          <button
            id="roomSecretToggleBtn"
            type="button"
            class="flex-shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border border-emerald-500 text-[11px] font-semibold text-emerald-700 bg-emerald-50 hover:bg-emerald-100"
          >
            ã“ã®éƒ¨å±‹ã®æƒ…å ±ã‚’è¡¨ç¤º
          </button>
        </div>

        <!-- â–¶ ã“ã“ã‹ã‚‰ä¸­èº«ï¼ˆæœ€åˆã¯ hiddenï¼‰ -->
        <div id="roomSecretBody" class="mt-3 hidden space-y-3">

          <!-- é›†åˆãƒã‚¹ãƒˆ -->
          <div id="roomMailboxSection" class="hidden border-t border-slate-100 pt-3 space-y-1">
            <p class="text-[11px] font-semibold text-slate-600">é›†åˆãƒã‚¹ãƒˆ</p>
            <p id="roomMailboxValue" class="text-sm font-mono text-slate-900"></p>
          </div>

          <!-- å®…é…ãƒœãƒƒã‚¯ã‚¹ -->
          <div id="roomDeliverySection" class="hidden border-t border-slate-100 pt-3 space-y-1">
            <p class="text-[11px] font-semibold text-slate-600">å®…é…ãƒœãƒƒã‚¯ã‚¹</p>
            <p id="roomDeliveryValue" class="text-sm font-mono text-slate-900"></p>
          </div>

          <!-- é§è¼ªå ´ -->
          <div id="roomBicycleSection" class="hidden border-t border-slate-100 pt-3 space-y-1">
            <p class="text-[11px] font-semibold text-slate-600">é§è¼ªå ´</p>
            <p id="roomBicycleValue" class="text-sm font-mono text-slate-900"></p>
          </div>

          <!-- Wi-Fi -->
          <div id="roomWifiSection" class="hidden border-t border-slate-100 pt-3 space-y-1">
            <p class="text-[11px] font-semibold text-slate-600">Wi-Fi</p>
            <p id="roomWifiSsid" class="text-xs font-mono text-slate-900"></p>
            <p id="roomWifiPass" class="text-xs font-mono text-slate-900"></p>
          </div>

        </div>
      </section>
      <!-- â–² éƒ¨å±‹å°‚ç”¨ã²ã¿ã¤æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->

      <!-- Property Meta -->
      <!-- âœ… å…¥å£ã§ã¯éè¡¨ç¤ºã«ã™ã‚‹ã®ã§ id ã‚’ä»˜ä¸ -->
      <section id="propertyMetaSection" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 space-y-2">
        <p id="propertyMeta" class="text-[11px] text-slate-400">æƒ…å ±ã‚’å–å¾—ä¸­</p>
        <p class="text-[11px] text-slate-400">
          â€» æ²è¼‰å†…å®¹ã¨å®Ÿéš›ã®å¥‘ç´„æ¡ä»¶ã«ç›¸é•ãŒã‚ã‚‹å ´åˆã¯ã€è³ƒè²¸å€Ÿå¥‘ç´„æ›¸ã®å†…å®¹ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
        </p>
      </section>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      <section id="errorBox" class="hidden rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"></section>

      <!-- Tabs -->
      <section>
        <div id="tabNav" class="flex flex-wrap gap-2 pb-1 text-xs"></div>
        <div id="tabPanels" class="mt-3 space-y-4"></div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-200 bg-white">
    <div class="max-w-4xl mx-auto px-4 py-3 text-[11px] text-slate-400 flex justify-between">
      <p>Â© ãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾</p>
      <p>å…¥å±…ã®ã—ãŠã‚Š</p>
    </div>
  </footer>

  <!-- ======================================================= -->
  <!-- JS -->
  <!-- ======================================================= -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDneH08GavPizbtH4Oi-RsTrwGerxXWSyQ",
      authDomain: "univlife-kanri.firebaseapp.com",
      projectId: "univlife-kanri",
      storageBucket: "univlife-kanri.firebasestorage.app",
      messagingSenderId: "405011982427",
      appId: "1:405011982427:web:cf56a37550ab714bfdb77e",
      measurementId: "G-DXMR0VL972"
    };

    const SECTION_KEYS = [
      "key",
      "mailbox",
      "delivery_box",
      "bicycle_space",
      "room_equipment",
      "special_note",
      "moving",
      "electricity",
      "gas",
      "water",
      "internet",
      "trash",
      "common_area",
      "pets",
      "toilet",
      "noise",
      "drainage",
      "ventilation",
      "heater",
      "air_conditioner",
      "bike_parking",
      "car_parking",
      "sales",
      "expenses",
      "cancellation",
      "management_other"
    ];

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    let db = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) {
      console.error("Firestore åˆæœŸåŒ–ã«å¤±æ•—:", e);
      db = null;
    }

    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function normalizeBool(v) {
      if (v === true) return true;
      if (v === false) return false;
      if (v === 1) return true;
      if (v === 0) return false;
      if (typeof v === "string") {
        const s = v.trim().toLowerCase();
        if (s === "true" || s === "1" || s === "yes") return true;
        if (s === "false" || s === "0" || s === "no") return false;
      }
      return false;
    }

    function showError(message) {
      const box = document.getElementById("errorBox");
      box.textContent = message;
      box.classList.remove("hidden");
    }

    async function loadSectionsMaster() {
      const colRef = collection(db, "sections_master");
      const snap = await getDocs(colRef);
      const map = {};
      snap.forEach((d) => { map[d.id] = d.data(); });
      return map;
    }

    async function loadPropertyShiori(propertyNo) {
      const ref = doc(db, "properties_shiori", propertyNo);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return snap.data();
    }

    async function loadGuidesMasterRaw() {
      const colRef = collection(db, "guides_master_raw");
      const snap = await getDocs(colRef);
      const list = [];
      snap.forEach((d) => {
        const data = d.data();
        list.push({
          section_key: data.section_key || "",
          variant_key: data.variant_key || "base",
          body_text: data.body_text || ""
        });
      });
      return list;
    }

    // token ã‹ã‚‰ postdials 1ä»¶å–å¾—
    async function loadRoomSecretByToken(token) {
      if (!token) return null;
      const colRef = collection(db, "postdials");
      const q = query(colRef, where("token", "==", token), limit(1));
      const snap = await getDocs(q);
      if (snap.empty) return null;
      const docSnap = snap.docs[0];
      return { id: docSnap.id, ...docSnap.data() };
    }

    function pickFirst(obj, keys) {
      for (const k of keys) {
        const v = obj?.[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return "";
    }

    // éƒ¨å±‹å°‚ç”¨ã‚«ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦
    function renderRoomSecretSection(roomData) {
      const section = document.getElementById("roomSecretSection");
      if (!section) return;

      const propertyName = roomData["ç‰©ä»¶å"] || "";
      const roomNo = roomData["å·å®¤"] || "";

      // å·å®¤ä¿æŒï¼ˆpropertiesèª­å¾Œã« canonicalName ã§ä¸Šæ›¸ãã™ã‚‹ï¼‰
      window.__roomNo = roomNo ? String(roomNo).trim() : "";

      const titleParts = [];
      if (propertyName) titleParts.push(propertyName);
      if (roomNo) titleParts.push(roomNo + "å·å®¤");
      document.getElementById("roomSecretTitle").textContent =
        titleParts.join(" ") || "ã“ã®ãŠéƒ¨å±‹";

      let hasAny = false;

      // é›†åˆãƒã‚¹ãƒˆ
      const mailbox = roomData["é–‹éŒ ç•ªå·"];
      if (mailbox && String(mailbox).trim() !== "") {
        document.getElementById("roomMailboxSection").classList.remove("hidden");
        document.getElementById("roomMailboxValue").textContent = String(mailbox);
        hasAny = true;
      }

      // å®…é…ãƒœãƒƒã‚¯ã‚¹
      const delivery = roomData["å®…é…ãƒœãƒƒã‚¯ã‚¹"];
      if (delivery && String(delivery).trim() !== "") {
        document.getElementById("roomDeliverySection").classList.remove("hidden");
        document.getElementById("roomDeliveryValue").textContent = String(delivery);
        hasAny = true;
      }

      // é§è¼ªå ´
      const bicycle = roomData["é§è¼ªå ´"];
      if (bicycle && String(bicycle).trim() !== "") {
        document.getElementById("roomBicycleSection").classList.remove("hidden");
        document.getElementById("roomBicycleValue").textContent = String(bicycle);
        hasAny = true;
      }

      // Wi-Fiï¼ˆã‚­ãƒ¼æºã‚Œå¯¾å¿œï¼‰
      const wifiSsid = pickFirst(roomData, [
        "Wi-Fi_SSID",
        "Wi-Fi SSID",
        "WiFi_SSID",
        "wifi_ssid",
        "wifiSsid",
        "ssid",
        "SSID"
      ]);

      const wifiPass = pickFirst(roomData, [
        "Wi-Fi_PASS",
        "Wi-Fi PASS",
        "WiFi_PASS",
        "wifi_pass",
        "wifiPass",
        "password",
        "PASS",
        "Password",
        "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
      ]);

      if (wifiSsid || wifiPass) {
        document.getElementById("roomWifiSection").classList.remove("hidden");
        if (wifiSsid) document.getElementById("roomWifiSsid").textContent = "SSID: " + String(wifiSsid);
        if (wifiPass) document.getElementById("roomWifiPass").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: " + String(wifiPass);
        hasAny = true;
      }

      if (hasAny) {
        section.classList.remove("hidden");

        const btn = document.getElementById("roomSecretToggleBtn");
        const body = document.getElementById("roomSecretBody");
        if (btn && body) {
          btn.addEventListener("click", () => {
            const hidden = body.classList.contains("hidden");
            if (hidden) {
              body.classList.remove("hidden");
              btn.textContent = "ã“ã®éƒ¨å±‹ã®æƒ…å ±ã‚’éš ã™";
            } else {
              body.classList.add("hidden");
              btn.textContent = "ã“ã®éƒ¨å±‹ã®æƒ…å ±ã‚’è¡¨ç¤º";
            }
          });
        }
      }
    }

    function pickBodyText(masterList, sectionKey, variantKey) {
      if (!masterList || masterList.length === 0) return "";
      const vKey = variantKey || "base";
      let hit = masterList.find(r => r.section_key === sectionKey && r.variant_key === vKey);
      if (hit && hit.body_text) return hit.body_text;
      hit = masterList.find(r => r.section_key === sectionKey && r.variant_key === "base");
      if (hit && hit.body_text) return hit.body_text;
      return "";
    }

    // æœ¬æ–‡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šMarkdownãƒªãƒ³ã‚¯ + æ”¹è¡Œä¿æŒ
    function renderPlainTextAsHtml(text) {
      if (!text) return "";
      let escaped = escapeHtml(text);

      // Markdownãƒªãƒ³ã‚¯ [label](url)
      escaped = escaped.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        (m, label, url) =>
          `<a href="${url}" target="_blank" rel="noopener" class="text-sky-600 underline">${label}</a>`
      );

      return escaped.replace(/\r?\n/g, "<br />");
    }

    function buildSectionConfig(propData) {
      if (!propData) return null;
      const config = {};
      SECTION_KEYS.forEach((key) => {
        const raw = propData[key];
        if (raw === undefined || raw === null || raw === "") {
          config[key] = { enabled: false, variant: null };
          return;
        }
        if (typeof raw === "boolean") {
          config[key] = { enabled: raw, variant: null };
          return;
        }
        if (typeof raw === "number") {
          config[key] = { enabled: raw !== 0, variant: null };
          return;
        }
        const s = String(raw).trim();
        const lower = s.toLowerCase();
        if (["false", "0", "no", "off"].includes(lower)) {
          config[key] = { enabled: false, variant: null };
          return;
        }
        if (["true", "1", "yes", "on", "base"].includes(lower)) {
          config[key] = { enabled: true, variant: null };
          return;
        }
        config[key] = { enabled: true, variant: s };
      });
      return config;
    }

    function mergeSections(masterMap, sectionConfig, masterList, defaultVariantKey) {
      const sections = [];
      Object.keys(masterMap).forEach((key) => {
        const master = masterMap[key] || {};
        if (sectionConfig && Object.prototype.hasOwnProperty.call(sectionConfig, key)) {
          const cfg = sectionConfig[key];
          if (!cfg.enabled) return;
          const vKey = cfg.variant || defaultVariantKey || "base";
          const body = pickBodyText(masterList, key, vKey);
          if (!body) return;
          sections.push({
            key,
            label: master.label_ja || key,
            summary: master.summary || "",
            group: master.group || "ãã®ä»–",
            order: typeof master.order === "number" ? master.order : 9999,
            icon: master.icon || "",
            body
          });
        } else {
          const vKey = defaultVariantKey || "base";
          const body = pickBodyText(masterList, key, vKey);
          if (!body) return;
          sections.push({
            key,
            label: master.label_ja || key,
            summary: master.summary || "",
            group: master.group || "ãã®ä»–",
            order: typeof master.order === "number" ? master.order : 9999,
            icon: master.icon || "",
            body
          });
        }
      });
      sections.sort((a, b) => a.order - b.order);
      return sections;
    }

    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆURLç”Ÿæˆï¼ˆtokenã‚ã‚Š/ãªã—ä¸¡å¯¾å¿œï¼‰
    function buildSurveyUrl({ token = "", propertyNo = "", source = "unknown" } = {}) {
      const base = "https://guide.univ-life.com/survey.html";
      const u = new URL(base);
      if (token) u.searchParams.set("token", token);
      if (!token && propertyNo) u.searchParams.set("propertyNo", propertyNo);
      u.searchParams.set("source", source);
      return u.toString();
    }

    function renderGroupedTabsWithAccordion(sections) {
      const tabNav = document.getElementById("tabNav");
      const tabPanels = document.getElementById("tabPanels");
      tabNav.innerHTML = "";
      tabPanels.innerHTML = "";

      if (!sections.length) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹å…¥å±…ã®ã—ãŠã‚Šã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
        return;
      }

      const groupMap = new Map();
      sections.forEach((sec) => {
        const gname = sec.group || "ãã®ä»–";
        if (!groupMap.has(gname)) {
          groupMap.set(gname, { name: gname, order: sec.order || 9999, icon: sec.icon || "", sections: [] });
        }
        const g = groupMap.get(gname);
        g.order = Math.min(g.order, sec.order || 9999);
        if (!g.icon && sec.icon) g.icon = sec.icon;
        g.sections.push(sec);
      });

      const groups = Array.from(groupMap.values()).sort((a, b) => {
        if (a.order !== b.order) return a.order - b.order;
        return a.name.localeCompare(b.name, "ja");
      });
      groups.forEach((g) => g.sections.sort((a, b) => a.order - b.order));

      groups.forEach((group, gIndex) => {
        const active = gIndex === 0;

        const tabBtn = document.createElement("button");
        tabBtn.type = "button";
        tabBtn.dataset.tabGroup = group.name;
        tabBtn.className =
          "group-tab inline-flex items-center justify-center px-3 py-1.5 " +
          "rounded-full whitespace-normal break-words text-[11px] leading-snug " +
          "text-center max-w-[48%] border shadow-sm " +
          (active
            ? "bg-slate-900 text-white border-slate-900"
            : "bg-slate-100 text-slate-700 border-slate-200");
        tabBtn.innerHTML = `<span>${escapeHtml(group.name)}</span>`;
        tabNav.appendChild(tabBtn);

        const panel = document.createElement("section");
        panel.dataset.tabGroupPanel = group.name;
        panel.className = (active ? "" : "hidden ") + "bg-transparent space-y-3";

        group.sections.forEach((sec) => {
          const bodyId = `g${gIndex}-sec-${sec.key}`;
          const expanded = false;

          const card = document.createElement("div");
          card.className =
            "bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden";

          // ç®¡ç†ï¼ãã®ä»–ã ã‘ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒœã‚¿ãƒ³
          const surveyUrl = (sec.key === "management_other")
            ? (window.__token
                ? buildSurveyUrl({ token: window.__token, source: "shiori_room" })
                : buildSurveyUrl({ propertyNo: window.__propertyNo || "", source: "shiori_public" })
              )
            : "";

          card.innerHTML = `
            <button
              type="button"
              class="w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 focus:outline-none"
              data-accordion-toggle="${bodyId}"
            >
              <div class="flex items-center gap-3 text-left">
                <div class="flex-shrink-0">
                  <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-100 text-slate-700">
                    <i data-lucide="${sec.icon || "file-text"}" class="w-4 h-4"></i>
                  </span>
                </div>
                <div>
                  <div class="text-sm font-semibold text-slate-900">
                    ${escapeHtml(sec.label)}
                  </div>
                  ${
                    sec.summary
                      ? `<div class="text-[11px] text-slate-500 mt-0.5">${escapeHtml(sec.summary)}</div>`
                      : ""
                  }
                </div>
              </div>
              <div class="ml-3 flex-shrink-0">
                <svg class="w-4 h-4 text-slate-400 transition-transform duration-150 ${
                  expanded ? "rotate-180" : ""
                }" data-chevron-for="${bodyId}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </button>
            <div
              id="${bodyId}"
              class="px-4 pb-4 pt-1 text-xs text-slate-700 leading-relaxed ${
                expanded ? "" : "hidden"
              }"
            >
              <div class="border-t border-slate-100 pt-2 richtext">
                ${renderPlainTextAsHtml(sec.body)}
                ${
                  sec.key === "management_other" && surveyUrl
                    ? `
                      <div class="mt-4">
                        <a href="${surveyUrl}"
                           target="_blank" rel="noopener"
                           class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm text-blue-700 hover:bg-slate-50">
                          ğŸ“ å…¥å±…ç›´å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆ1åˆ†ï¼‰
                        </a>
                        <div class="text-[11px] text-slate-400 mt-1">ä»»æ„ï¼ä»Šå¾Œã®æ”¹å–„ã«æ´»ç”¨ã—ã¾ã™</div>
                      </div>
                    `
                    : ""
                }
              </div>
            </div>
          `;

          panel.appendChild(card);
        });

        tabPanels.appendChild(panel);
      });

      document.querySelectorAll(".group-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const target = tab.dataset.tabGroup;
          document.querySelectorAll(".group-tab").forEach((t) => {
            const active = t === tab;
            t.classList.toggle("bg-slate-900", active);
            t.classList.toggle("text-white", active);
            t.classList.toggle("border-slate-900", active);
            t.classList.toggle("bg-slate-100", !active);
            t.classList.toggle("text-slate-700", !active);
            t.classList.toggle("border-slate-200", !active);
          });
          document.querySelectorAll("[data-tab-group-panel]").forEach((p) => {
            p.classList.toggle("hidden", p.dataset.tabGroupPanel !== target);
          });
        });
      });

      document.querySelectorAll("[data-accordion-toggle]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const bodyId = btn.getAttribute("data-accordion-toggle");
          const bodyEl = document.getElementById(bodyId);
          const chevron = btn.querySelector('[data-chevron-for="' + bodyId + '"]');
          if (!bodyEl) return;
          const isHidden = bodyEl.classList.contains("hidden");
          if (isHidden) {
            bodyEl.classList.remove("hidden");
            if (chevron) chevron.classList.add("rotate-180");
          } else {
            bodyEl.classList.add("hidden");
            if (chevron) chevron.classList.remove("rotate-180");
          }
        });
      });

      if (window.lucide && typeof window.lucide.createIcons === "function") {
        window.lucide.createIcons();
      }
    }

    async function main() {
      const tabPanels = document.getElementById("tabPanels");
      const tabNav = document.getElementById("tabNav");

      if (!db) {
        showError("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        return;
      }

      const url = new URL(window.location.href);
      let propertyNo = url.searchParams.get("propertyNo") || "";
      const token = url.searchParams.get("token") || "";

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿æŒ
      window.__token = token || "";

      // ===============================
      // âœ… TOPï¼ˆ/ï¼‰ã¯ã€Œèª¬æ˜ãƒšãƒ¼ã‚¸ã€ï¼ˆpropertyNo/token ç„¡ã—ï¼‰
      // ===============================
      if (!propertyNo && !token) {
        // å…¥å£ã¯ meta ã‚’éš ã™
        document.getElementById("propertyMetaSection")?.classList.add("hidden");

        // ã‚¿ã‚¤ãƒˆãƒ«å›ºå®š
        document.getElementById("propertyTitle").textContent = "å…¥å±…ã®ã—ãŠã‚Šï¼ˆWebï¼‰";
        document.title = "å…¥å±…ã®ã—ãŠã‚Šï½œãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾";

        // ã‚¿ãƒ–ã¯ä¸è¦
        if (tabNav) tabNav.innerHTML = "";

        tabPanels.innerHTML = `
          <section class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-slate-900">å…¥å±…ã®ã—ãŠã‚Šï¼ˆWebï¼‰</h2>

            <div class="text-sm text-slate-700 leading-relaxed space-y-2">
              <p>æœ¬ãƒšãƒ¼ã‚¸ã¯ã€ãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾ãŒç®¡ç†ã™ã‚‹è³ƒè²¸ç‰©ä»¶ã®å…¥å±…è€…æ§˜å‘ã‘ã€Œå…¥å±…ã®ã—ãŠã‚Šï¼ˆWebç‰ˆï¼‰ã€ã§ã™ã€‚</p>
              <p>ã‚´ãƒŸå‡ºã—æ–¹æ³•ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆåˆ©ç”¨æ–¹æ³•ã€è¨­å‚™ã®ä½¿ã„æ–¹ã€ç”Ÿæ´»ãƒ«ãƒ¼ãƒ«ãªã©ã‚’ç‰©ä»¶ã”ã¨ã«æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚</p>
              <p class="text-slate-500 text-xs">â€» ç‰©ä»¶åˆ¥ãƒšãƒ¼ã‚¸ã¯ã€éµæ¸¡ã—æ›¸é¡ã®QRã‚³ãƒ¼ãƒ‰ï¼URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <div class="pt-2">
              <a href="/list.html" class="text-slate-300 hover:text-slate-400 text-xs underline">
                å…¥å±…ã®ã—ãŠã‚Šä¸€è¦§
              </a>
            </div>
          </section>
        `;
        return;
      }

      // token ãŒã‚ã‚Œã° postdials ã‹ã‚‰ç‰©ä»¶No ã‚’æ±ºã‚ã‚‹ï¼†éƒ¨å±‹ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
      if (token) {
        try {
          const roomData = await loadRoomSecretByToken(token);
          if (!roomData) {
            showError("token=" + token + " ã§ postdials ã‚’æ¤œç´¢ã—ã¾ã—ãŸãŒã€è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            tabPanels.innerHTML = "";
            return;
          }
          renderRoomSecretSection(roomData);

          const bukkenNo = roomData["ç‰©ä»¶No"];
          if (!bukkenNo || String(bukkenNo).trim() === "") {
            showError("postdials ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€ç‰©ä»¶Noã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            tabPanels.innerHTML = "";
            return;
          }
          propertyNo = String(bukkenNo).trim();
        } catch (e) {
          console.error("éƒ¨å±‹æƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
          showError("ãŠéƒ¨å±‹å°‚ç”¨æƒ…å ±ï¼ˆpostdialsï¼‰ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
          tabPanels.innerHTML = "";
          return;
        }
      }

      if (!propertyNo) {
        showError("URL ã« ?propertyNo=XXXX ã¾ãŸã¯ ?token=XXXX ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
        tabPanels.innerHTML = "";
        return;
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿æŒï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆURLç”Ÿæˆã§ä½¿ç”¨ï¼‰
      window.__propertyNo = propertyNo;

      try {
        const results = await Promise.allSettled([
          loadSectionsMaster(),
          loadPropertyShiori(propertyNo),
          loadGuidesMasterRaw()
        ]);

        if (
          results[0].status === "rejected" ||
          results[1].status === "rejected" ||
          results[2].status === "rejected"
        ) {
          console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", results);
          showError("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          return;
        }

        const masterMap = results[0].value || {};
        const propertyData = results[1].value || null;
        const masterList = results[2].value || [];

        if (!propertyData) {
          showError("ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šè¨­å®šãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          tabPanels.innerHTML = "";
          return;
        }

        const title =
          propertyData.canonicalName ||
          propertyData.propertyName ||
          "ç‰©ä»¶No. " + propertyNo;

        document.getElementById("propertyTitle").textContent = title;
        document.title = `${title}ï½œå…¥å±…ã®ã—ãŠã‚Šï½œãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾`;

        // éƒ¨å±‹ã‚«ãƒ¼ãƒ‰ã®ç‰©ä»¶åè¡¨è¨˜ã‚’ canonicalName ã«çµ±ä¸€
        const roomTitleEl = document.getElementById("roomSecretTitle");
        const roomSectionEl = document.getElementById("roomSecretSection");
        if (roomTitleEl && roomSectionEl && !roomSectionEl.classList.contains("hidden")) {
          const rn = (window.__roomNo || "").replace(/å·å®¤$/, "").trim();
          roomTitleEl.textContent = rn ? `${title} ${rn}å·å®¤` : title;
        }

        const zip = pickFirst(propertyData, ["zip_code", "postal_code", "éƒµä¾¿ç•ªå·"]);
        const address = pickFirst(propertyData, ["address", "ä½æ‰€"]);

        // ===============================
        // SEOï¼ˆå…±é€šãƒšãƒ¼ã‚¸ã ã‘ index å¯¾è±¡ï¼‰
        // - tokenãƒšãƒ¼ã‚¸: noindex
        // - propertyNoãƒšãƒ¼ã‚¸: index + canonical
        // - title/description å‹•çš„
        // - æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆJSON-LDï¼‰
        // ===============================
        (function applySeo() {
          const url = new URL(window.location.href);
          const tokenParam = url.searchParams.get("token") || "";

          // tokenãƒšãƒ¼ã‚¸ã¯ noindexï¼ˆå¿…é ˆï¼‰
          if (tokenParam) {
            let robots = document.querySelector('meta[name="robots"]');
            if (!robots) {
              robots = document.createElement("meta");
              robots.name = "robots";
              document.head.appendChild(robots);
            }
            robots.content = "noindex,nofollow";
            return;
          }

          // propertyNoãƒšãƒ¼ã‚¸ã¯ canonical ã‚’å›ºå®š
          if (propertyNo) {
            let canonical = document.querySelector('link[rel="canonical"]');
            if (!canonical) {
              canonical = document.createElement("link");
              canonical.rel = "canonical";
              document.head.appendChild(canonical);
            }
            canonical.href = `https://guide.univ-life.com/?propertyNo=${propertyNo}`;
          }

          // title / description ã‚’ç‰©ä»¶ã”ã¨ã«å‹•çš„åŒ–
          const safeTitle = title || ("ç‰©ä»¶No. " + propertyNo);
          document.title = `${safeTitle}ï½œå…¥å±…ã®ã—ãŠã‚Šï½œãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾`;

          let metaDesc = document.querySelector('meta[name="description"]');
          if (!metaDesc) {
            metaDesc = document.createElement("meta");
            metaDesc.name = "description";
            document.head.appendChild(metaDesc);
          }

          const addrText = [zip ? `ã€’${zip}` : "", address || ""].filter(Boolean).join(" ");
          metaDesc.content =
            `${safeTitle}ã®å…¥å±…ã®ã—ãŠã‚Šï¼ˆå…¥å±…è€…å‘ã‘æ¡ˆå†…ï¼‰ã§ã™ã€‚` +
            `ã‚´ãƒŸå‡ºã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã€è¨­å‚™ã€æ³¨æ„äº‹é …ãªã©ã‚’æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚` +
            (addrText ? `æ‰€åœ¨åœ°ï¼š${addrText}` : "");

          const ld = {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": `${safeTitle}ï½œå…¥å±…ã®ã—ãŠã‚Š`,
            "description": metaDesc.content,
            "url": `https://guide.univ-life.com/?propertyNo=${propertyNo}`,
            "publisher": {
              "@type": "Organization",
              "name": "ãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾"
            }
          };

          const existing = document.getElementById("ldjson-shiori");
          if (existing) existing.remove();

          const script = document.createElement("script");
          script.type = "application/ld+json";
          script.id = "ldjson-shiori";
          script.textContent = JSON.stringify(ld);
          document.head.appendChild(script);
        })();

        const metaEl = document.getElementById("propertyMeta");
        if (zip && address) {
          metaEl.textContent = `ã€’${zip}ã€€${address}`;
        } else if (address) {
          metaEl.textContent = address;
        } else {
          metaEl.textContent = "æ‰€åœ¨åœ°æƒ…å ±ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™";
        }

        if (normalizeBool(propertyData.shiori_enabled) === false) {
          tabPanels.innerHTML =
            '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šã¯æº–å‚™ä¸­ã§ã™ã€‚</p>';
          return;
        }

        const defaultVariantKey = propertyData.variant_key || "base";
        const sectionConfig = buildSectionConfig(propertyData);
        const mergedSections = mergeSections(
          masterMap,
          sectionConfig,
          masterList,
          defaultVariantKey
        );

        renderGroupedTabsWithAccordion(mergedSections);
      } catch (e) {
        console.error("main() å†…ã§ã‚¨ãƒ©ãƒ¼:", e);
        showError("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    document.addEventListener("DOMContentLoaded", main);
  </script>

</body>
</html>
