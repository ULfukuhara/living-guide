<script>
  // ========= 設定 =========
  // ★ Preview トークンを使う（紫の方）
  const STORYBLOK_TOKEN = "ir2Hm2c38mI69te9Vr92RAtt";
  const STORYBLOK_VERSION = "draft"; // 開発中は draft 固定でOK

  // ========= URL から propertyNo を取得 =========
  function getPropertyNoFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const raw = params.get("propertyNo") || "10100"; // デフォルトを 10100 に
    return raw.toString().trim();
  }

  const propertyNo = getPropertyNoFromUrl();
  document.getElementById("propertyNo").textContent = `物件No：${propertyNo}`;

  // ========= Storyblok から Story を取得 =========
  async function loadStoryblokGuide(propertyNo) {
    // 今回は full_slug が "10100" なので、そのまま slug として使う
    const storySlug = propertyNo;

    const apiUrl =
      "https://api.storyblok.com/v2/cdn/stories/" +
      encodeURIComponent(storySlug) +
      `?token=${STORYBLOK_TOKEN}&version=${STORYBLOK_VERSION}`;

    console.log("Storyblok API URL:", apiUrl);  // デバッグ用

    try {
      const res = await fetch(apiUrl);
      console.log("Status:", res.status);       // デバッグ用

      if (!res.ok) {
        const text = await res.text();
        console.log("Response text:", text);    // デバッグ用
        throw new Error(`Storyblok API error: ${res.status} ${res.statusText}`);
      }

      const data = await res.json();
      const story = data.story;
      const content = story.content;

      // タイトル
      const titleEl = document.getElementById("propertyTitle");
      titleEl.textContent = content.title || story.name || `入居のしおり（${propertyNo}）`;

      // sections を描画
      renderSections(content.sections || []);
    } catch (error) {
      console.error("データ取得に失敗しました:", error);
      const bodyEl = document.getElementById("guideBody");
      bodyEl.innerHTML =
        '<p class="text-sm text-red-600">入居のしおりの読み込みに失敗しました。管理会社までご連絡ください。</p>';
    }
  }

  // ========= sections（section配列）を画面に描画 =========
  function renderSections(sections) {
    const container = document.getElementById("guideBody");
    container.innerHTML = "";

    if (!sections.length) {
      container.innerHTML =
        '<p class="text-sm text-slate-500">入居のしおりの内容がまだ登録されていません。</p>';
      return;
    }

    sections.forEach((section) => {
      if (!section) return;

      const wrapper = document.createElement("section");
      wrapper.className = "space-y-2";

      const h2 = document.createElement("h2");
      h2.className =
        "text-lg font-semibold text-slate-800 border-b border-slate-200 pb-1";
      h2.textContent = section.headline || "";

      const bodyDiv = document.createElement("div");
      bodyDiv.className = "text-slate-800 whitespace-pre-line";

      const plainText = richtextToPlainText(section.body);
      bodyDiv.textContent = plainText;

      wrapper.appendChild(h2);
      wrapper.appendChild(bodyDiv);
      container.appendChild(wrapper);
    });
  }

  // ========= Richtext → プレーンテキスト =========
  function richtextToPlainText(rich) {
    if (!rich || !Array.isArray(rich.content)) return "";
    const lines = [];

    rich.content.forEach((node) => {
      if (node.type === "paragraph" && Array.isArray(node.content)) {
        const line = node.content
          .map((child) => (child.text ? child.text : ""))
          .join("");
        lines.push(line);
      }
    });

    return lines.join("\n\n");
  }

  // ========= 実行 =========
  loadStoryblokGuide(propertyNo);
</script>
