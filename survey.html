<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入居直後アンケート | UNIV LIFE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .rating label { cursor: pointer; }
    .rating input { transform: scale(1.15); margin-right: 8px; }
    .stars {
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-sm p-6 space-y-5">
    <p id="metaLine" class="text-[10px] text-slate-400"></p>

    <div id="errorLine" class="hidden rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"></div>

    <!-- 状態表示（回答済み / 送信完了） -->
    <div id="statusBox" class="hidden space-y-4 text-center">
      <p id="statusTitle" class="text-sm text-emerald-700 font-semibold"></p>
      <p id="statusDesc" class="text-xs text-slate-500"></p>

      <!-- 回答済みの時だけ表示 -->
      <button id="retryBtn"
        class="hidden w-full rounded-lg border px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
        もう一度回答する
      </button>

      <!-- 送信完了の時だけ表示（任意） -->
      <a id="closeLink" href="https://guide.univ-life.com/"
         class="hidden w-full inline-flex justify-center rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm font-semibold hover:bg-emerald-700">
        入居のしおりに戻る
      </a>
    </div>

    <!-- フォーム -->
    <form id="surveyForm" class="hidden space-y-6">
      <div class="space-y-1">
        <h1 class="text-base font-semibold text-slate-800">
          ご入居後のご感想を教えてください
        </h1>
        <p class="text-xs text-slate-500">所要時間：1分程度</p>
      </div>

      <!-- Q1 -->
      <div>
        <p class="text-sm font-medium">① お部屋の状態はいかがでしたか？</p>
        <div class="rating mt-2 space-y-2 text-sm">
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="5">
            <span class="stars">★★★★★</span><span class="ml-2">とても満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="4">
            <span class="stars">★★★★☆</span><span class="ml-2">満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="3">
            <span class="stars">★★★☆☆</span><span class="ml-2">ふつう</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="2">
            <span class="stars">★★☆☆☆</span><span class="ml-2">やや不満</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="room" value="1">
            <span class="stars">★☆☆☆☆</span><span class="ml-2">不満</span>
          </label>
        </div>
      </div>

      <!-- Q2 -->
      <div>
        <p class="text-sm font-medium">② お部屋探し（仲介）はいかがでしたか？</p>
        <div class="rating mt-2 space-y-2 text-sm">
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="5">
            <span class="stars">★★★★★</span><span class="ml-2">とても満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="4">
            <span class="stars">★★★★☆</span><span class="ml-2">満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="3">
            <span class="stars">★★★☆☆</span><span class="ml-2">ふつう</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="2">
            <span class="stars">★★☆☆☆</span><span class="ml-2">やや不満</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="broker" value="1">
            <span class="stars">★☆☆☆☆</span><span class="ml-2">不満</span>
          </label>
        </div>
      </div>

      <!-- Q3 -->
      <div>
        <p class="text-sm font-medium">③ 管理会社の対応や入居のしおりは分かりやすかったですか？</p>
        <div class="rating mt-2 space-y-2 text-sm">
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="5">
            <span class="stars">★★★★★</span><span class="ml-2">とても満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="4">
            <span class="stars">★★★★☆</span><span class="ml-2">満足</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="3">
            <span class="stars">★★★☆☆</span><span class="ml-2">ふつう</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="2">
            <span class="stars">★★☆☆☆</span><span class="ml-2">やや不満</span>
          </label>
          <label class="flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50">
            <input type="radio" name="management" value="1">
            <span class="stars">★☆☆☆☆</span><span class="ml-2">不満</span>
          </label>
        </div>
      </div>

      <!-- Q4 -->
      <div>
        <p class="text-sm font-medium">④ 気になった点・ご要望があれば教えてください（任意）</p>
        <textarea id="comment"
          class="mt-2 w-full rounded-lg border border-slate-300 p-2 text-sm"
          rows="3"
          placeholder="例）しおりの○○が分かりにくかった／設備の△△が気になる など"></textarea>
      </div>

      <button type="button" id="submitBtn"
        class="w-full rounded-lg bg-emerald-600 text-white py-2 text-sm font-semibold hover:bg-emerald-700">
        送信
      </button>

      <p class="text-[11px] text-slate-400">※ 送信内容はサービス改善の目的で利用します。</p>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDneH08GavPizbtH4Oi-RsTrwGerxXWSyQ",
      authDomain: "univlife-kanri.firebaseapp.com",
      projectId: "univlife-kanri",
      storageBucket: "univlife-kanri.firebasestorage.app",
      messagingSenderId: "405011982427",
      appId: "1:405011982427:web:cf56a37550ab714bfdb77e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // URL params
    const pageUrl = new URL(window.location.href);
    const token = (pageUrl.searchParams.get("token") || "").trim();
    let propertyNo = (pageUrl.searchParams.get("propertyNo") || "").trim(); // ★ tokenから補完するのでlet
    const source = (pageUrl.searchParams.get("source") || "unknown").trim();

    // 状態：既に回答済みで表示された→再回答したかどうか
    let isResubmission = false;

    function showError(msg) {
      const el = document.getElementById("errorLine");
      el.textContent = msg;
      el.classList.remove("hidden");
    }

    function hideError() {
      document.getElementById("errorLine").classList.add("hidden");
      document.getElementById("errorLine").textContent = "";
    }

    function getScore(name) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? Number(el.value) : null;
    }

    // token → postdials から物件No取得
    async function fetchPropertyNoFromToken() {
      if (!token) return "";
      const q1 = query(collection(db, "postdials"), where("token", "==", token), limit(1));
      const snap = await getDocs(q1);
      if (snap.empty) return "";
      const data = snap.docs[0].data() || {};
      const bukkenNo = data["物件No"] || data["propertyNo"] || data["bukkenNo"] || "";
      return String(bukkenNo).trim();
    }

    async function checkAnsweredByToken() {
      if (!token) return false;
      const q1 = query(collection(db, "movein_survey"), where("token", "==", token), limit(1));
      const snap = await getDocs(q1);
      return !snap.empty;
    }

    function localKey() {
      return `movein_survey_answered_${propertyNo || "unknown"}`;
    }
    function checkAnsweredLocal() {
      try { return localStorage.getItem(localKey()) === "1"; } catch { return false; }
    }
    function markAnsweredLocal() {
      try { localStorage.setItem(localKey(), "1"); } catch {}
    }

    function showStatus({ title, desc, showRetry = false, showClose = false } = {}) {
      document.getElementById("surveyForm").classList.add("hidden");

      const box = document.getElementById("statusBox");
      const titleEl = document.getElementById("statusTitle");
      const descEl = document.getElementById("statusDesc");
      const retryBtn = document.getElementById("retryBtn");
      const closeLink = document.getElementById("closeLink");

      titleEl.textContent = title || "";
      descEl.textContent = desc || "";

      retryBtn.classList.toggle("hidden", !showRetry);
      closeLink.classList.toggle("hidden", !showClose);

      box.classList.remove("hidden");
    }

    function showForm() {
      hideError();
      document.getElementById("statusBox").classList.add("hidden");
      document.getElementById("surveyForm").classList.remove("hidden");
    }

    async function submitSurvey() {
      hideError();

      if (getScore("room") === null || getScore("broker") === null || getScore("management") === null) {
        showError("①〜③は選択してください。");
        return;
      }

      const btn = document.getElementById("submitBtn");
      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "送信中…";

      try {
        const data = {
          token: token || null,
          propertyNo: propertyNo || null,
          source,
          room_score: getScore("room"),
          broker_score: getScore("broker"),
          management_score: getScore("management"),
          comment: document.getElementById("comment").value || "",
          created_at: serverTimestamp(),
          user_agent: navigator.userAgent
        };

        await addDoc(collection(db, "movein_survey"), data);

        // token無し（公開URL）の場合だけ localStorage で「回答済み」を残す
        if (!token) markAnsweredLocal();

        // ✅ 送信後メッセージ（再回答かどうかで分岐）
        if (isResubmission) {
          showStatus({
            title: "✅ 再度のご回答を受け付けました",
            desc: "追加入力いただいた内容も、サービス改善に活用いたします。ご協力ありがとうございます。",
            showRetry: false,
            showClose: true
          });
        } else {
          showStatus({
            title: "✅ ご回答ありがとうございました",
            desc: "いただいた内容はサービス改善に活用いたします。ご協力ありがとうございます。",
            showRetry: false,
            showClose: true
          });
        }
      } catch (e) {
        console.error(e);
        showError("送信に失敗しました。時間をおいて再度お試しください。");
      } finally {
        btn.disabled = false;
        btn.textContent = oldText;
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // tokenあり & propertyNoなし → Firestore(postdials) から補完
      if (token && !propertyNo) {
        try {
          propertyNo = await fetchPropertyNoFromToken();
          if (!propertyNo) {
            showError("tokenから物件Noを特定できませんでした。管理会社へご連絡ください。");
          }
        } catch (e) {
          console.error(e);
          showError("物件情報の取得に失敗しました。時間をおいて再度お試しください。");
        }
      }

      // メタ表示
      const metaParts = [];
      if (token) metaParts.push("tokenあり");
      if (propertyNo) metaParts.push(`物件No: ${propertyNo}`);
      metaParts.push(`source: ${source}`);
      document.getElementById("metaLine").textContent = metaParts.join(" / ");

      // 最低限の入力チェック
      if (!token && !propertyNo) {
        showError("URLに ?propertyNo=XXXX もしくは ?token=XXXX を付けてください。");
        showForm();
        return;
      }

      // 「回答済み」なら statusBox を表示（再回答ボタンあり）
      try {
        if (token) {
          const answered = await checkAnsweredByToken();
          if (answered) {
            showStatus({
              title: "✅ このアンケートはすでにご回答いただいています",
              desc: "追加でお気づきの点がありましたら、再度ご回答いただけます。",
              showRetry: true,
              showClose: false
            });
          } else {
            showForm();
          }
        } else {
          if (checkAnsweredLocal()) {
            showStatus({
              title: "✅ このアンケートはすでにご回答いただいています",
              desc: "追加でお気づきの点がありましたら、再度ご回答いただけます。",
              showRetry: true,
              showClose: false
            });
          } else {
            showForm();
          }
        }
      } catch (e) {
        console.error(e);
        // 判定に失敗しても入力はできるようにする
        showForm();
      }

      // 再回答：フォーム表示＋フラグON（送信後に「再度受け付けました」を出す）
      document.getElementById("retryBtn").addEventListener("click", () => {
        isResubmission = true;
        showForm();
      });

      document.getElementById("submitBtn").addEventListener("click", submitSurvey);
    });
  </script>
</body>
</html>
