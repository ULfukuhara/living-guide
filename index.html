<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å…¥å±…ã®ã—ãŠã‚Š | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 id="propertyTitle" class="text-lg font-semibold text-slate-800">
          ç‰©ä»¶åã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
        </h1>
        <p id="propertyMeta" class="text-xs text-slate-500">æƒ…å ±ã‚’å–å¾—ä¸­</p>
      </div>
      <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
        Guide
      </span>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 max-w-3xl mx-auto w-full px-4 py-6">

    <!-- Tabs -->
    <div id="tabNav" class="flex gap-2 overflow-x-auto pb-3"></div>

    <!-- Panels -->
    <div id="tabPanels" class="mt-4 space-y-4"></div>

  </main>

  <script>
    /* ------------------ Firebase Config ------------------ */
    const firebaseConfig = {
      apiKey: "AIzaSyDneH08GavPizbtH4Oi-RsTrwGerxXWSyQ",
      authDomain: "univlife-kanri.firebaseapp.com",
      projectId: "univlife-kanri",
      storageBucket: "univlife-kanri.firebasestorage.app",
      messagingSenderId: "405011982427",
      appId: "1:405011982427:web:cf56a37550ab714bfdb77e",
      measurementId: "G-DXMR0VL972"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ------------------ Storyblok CDN API ------------------ */
    const STORYBLOK_TOKEN = "sdvg2FfGE4TIQ6wTLIJItQtt";

    /* ------------------ Section Keys ------------------ */
    const SECTION_KEYS = [
      "key","mailbox","delivery_box","bicycle_space","room_equipment",
      "special_note","moving","electricity","gas","water","internet",
      "trash","common_area","pets","toilet","noise","drainage",
      "ventilation","heater","bike_parking","car_parking","sales",
      "expenses","cancellation"
    ];

    /* ------------------ Category Definitions ------------------ */
    const CATEGORY_DEFS = {
      basic:   { label: "ç”Ÿæ´»ã®åŸºæœ¬",     icon: "ğŸ " },
      trouble: { label: "ãƒˆãƒ©ãƒ–ãƒ«ãƒ»è¨­å‚™", icon: "ğŸ”§" },
      contract:{ label: "å¥‘ç´„ãƒ»è²»ç”¨",     icon: "ğŸ’°" },
      parking: { label: "é§è¼ªãƒ»é§è»Š",     icon: "ğŸš²" },
      other:   { label: "ãã®ä»–",         icon: "ğŸ“˜" }
    };

    /* ---------------------------------------------------------
       Util
    --------------------------------------------------------- */
    function escapeHtml(str) {
      if (!str) return "";
      return str.replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;",
        '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    function renderPlainTextAsHtml(txt) {
      if (!txt) return "";
      return escapeHtml(txt).replace(/\n/g, "<br>");
    }

    function renderRichText(body) {
      return renderPlainTextAsHtml(body);
    }

    function pickBodyText(masterList, sectionKey, variantKey) {
      let hit = masterList.find(
        r => r.section_key === sectionKey && r.variant_key === variantKey
      );
      if (hit && hit.body_text) return hit.body_text;

      hit = masterList.find(
        r => r.section_key === sectionKey && r.variant_key === "base"
      );
      if (hit && hit.body_text) return hit.body_text;

      return "";
    }

    function buildSectionFlags(propertyData) {
      const flags = {};
      SECTION_KEYS.forEach(key => {
        const val = propertyData[key];
        if (val === false || val === 0 || val === "0") {
          flags[key] = false;
        } else {
          flags[key] = true;
        }
      });
      return flags;
    }

    /* ---------------------------------------------------------
       Tabs
    --------------------------------------------------------- */
    function setupTabs() {
      const buttons = document.querySelectorAll("[data-tab]");
      const panels = document.querySelectorAll("[data-tab-panel]");

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          buttons.forEach(b =>
            b.classList.remove("bg-slate-900", "text-white")
          );
          panels.forEach(p => p.classList.add("hidden"));

          btn.classList.add("bg-slate-900", "text-white");
          document.querySelector(`[data-tab-panel='${tab}']`)
            .classList.remove("hidden");
        });
      });
    }

    /* ---------------------------------------------------------
       Render Guide Page
    --------------------------------------------------------- */
    function renderGuidePage(story, options) {
      const { propertyData, sectionFlags, masterList, variantKey } = options;

      const content = story.content || {};
      const sections = content.sections || [];

      document.getElementById("propertyTitle").textContent =
        content.title || story.name || "å…¥å±…ã®ã—ãŠã‚Š";

      const meta = document.getElementById("propertyMeta");
      if (propertyData) {
        const parts = [];
        if (propertyData.propertyNo) parts.push(`ç‰©ä»¶No. ${propertyData.propertyNo}`);
        if (propertyData.canonicalName) parts.push(propertyData.canonicalName);
        if (propertyData.address) parts.push(propertyData.address);
        meta.textContent = parts.join(" ï½œ ");
      } else {
        meta.textContent = content.propertyNo
          ? `ç‰©ä»¶No. ${content.propertyNo}` : "";
      }

      const tabNav = document.getElementById("tabNav");
      const tabPanels = document.getElementById("tabPanels");

      tabNav.innerHTML = "";
      tabPanels.innerHTML = "";

      if (propertyData && propertyData.shiori_enabled === false) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šã¯æº–å‚™ä¸­ã§ã™ã€‚</p>';
        return;
      }

      if (!sections.length) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šã¯æº–å‚™ä¸­ã§ã™ã€‚</p>';
        return;
      }

      const grouped = {};
      sections.forEach((sec, idx) => {
        const key = sec.key || sec._uid || `sec${idx}`;
        let show = true;
        if (sectionFlags && key in sectionFlags) {
          show = sectionFlags[key];
        } else if (sec.show_tab === false) {
          show = false;
        }
        if (!show) return;

        const cat = sec.category || "basic";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ sec, key });
      });

      const categoryKeys = Object.keys(grouped);
      if (!categoryKeys.length) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      const orderedCategoryKeys =
        Object.keys(CATEGORY_DEFS).filter(k => categoryKeys.includes(k));

      orderedCategoryKeys.forEach((catKey, idx) => {
        const def = CATEGORY_DEFS[catKey] || { label: catKey, icon: "" };
        const isActive = idx === 0;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.tab = catKey;
        btn.className =
          "tab-btn px-3 py-1.5 rounded-full whitespace-nowrap text-xs sm:text-sm " +
          (isActive ? "bg-slate-900 text-white" : "bg-slate-100 text-slate-700");
        btn.innerHTML =
          (def.icon ? `<span>${def.icon}</span> ` : "") +
          `<span>${escapeHtml(def.label)}</span>`;
        tabNav.appendChild(btn);

        const panel = document.createElement("section");
        panel.dataset.tabPanel = catKey;
        panel.className = "tab-panel space-y-3 " + (isActive ? "" : "hidden");

        const cardsHtml = grouped[catKey]
          .map(({ sec, key }) => {
            const title = sec.title || "ã‚»ã‚¯ã‚·ãƒ§ãƒ³";
            const icon = sec.icon || "";
            const summary = sec.summary || "";

            const textFromMaster = pickBodyText(
              masterList, key, variantKey
            );
            const bodyHtml = textFromMaster
              ? renderPlainTextAsHtml(textFromMaster)
              : renderRichText(sec.body);

            return `
              <article class="bg-white rounded-2xl shadow-sm border border-slate-100">
                <details class="group">
                  <summary class="flex items-center justify-between gap-3 px-4 py-3 cursor-pointer">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        ${icon ? `<span class="text-lg">${icon}</span>` : ""}
                        <h3 class="text-sm sm:text-base font-semibold text-slate-900 truncate">
                          ${escapeHtml(title)}
                        </h3>
                      </div>
                      ${
                        summary
                          ? `<p class="mt-0.5 text-[11px] sm:text-xs text-slate-500 line-clamp-2">${escapeHtml(
                              summary
                            )}</p>`
                          : ""
                      }
                    </div>
                    <span class="ml-2 text-slate-400 group-open:rotate-180 transition-transform">
                      â–¼
                    </span>
                  </summary>
                  <div class="px-4 pb-4 border-t border-slate-100">
                    <div class="richtext mt-3 text-xs sm:text-sm text-slate-700 leading-relaxed">
                      ${bodyHtml}
                    </div>
                  </div>
                </details>
              </article>
            `;
          })
          .join("");

        panel.innerHTML = cardsHtml;
        tabPanels.appendChild(panel);
      });

      setupTabs();
    }

    /* ---------------------------------------------------------
       Main Load
    --------------------------------------------------------- */
    async function main() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        let propertyNo = urlParams.get("propertyNo") || "";

        if (!propertyNo) {
          document.getElementById("propertyTitle").textContent =
            "ç‰©ä»¶NoãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“";
          document.getElementById("tabPanels").innerHTML =
            `<p class="text-sm text-slate-600">URL ã« ?propertyNo=XXXX ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚</p>`;
          return;
        }

        const propSnap = await db
          .collection("properties_shiori")
          .doc(propertyNo)
          .get();

        let propertyData = null;
        let slug = propertyNo;
        let variantKey = "base";
        let sectionFlags = null;

        if (propSnap.exists) {
          propertyData = propSnap.data();
          slug = propertyData.shiori_slug || propertyNo;
          variantKey = propertyData.variant_key || "base";
          sectionFlags = buildSectionFlags(propertyData);
        }

        const sbUrl = `https://api.storyblok.com/v2/cdn/stories/${slug}?version=published&token=${STORYBLOK_TOKEN}`;
        const sbRes = await fetch(sbUrl);
        if (!sbRes.ok) throw new Error("Storyblok API error");
        const sbData = await sbRes.json();

        const masterSnap = await db.collection("guides_master_raw").get();
        const masterList = [];
        masterSnap.forEach(doc => masterList.push(doc.data()));

        renderGuidePage(sbData.story, {
          propertyData,
          sectionFlags,git
          masterList,
          variantKey,
        });

      } catch (err) {
        console.error(err);
        document.getElementById("tabPanels").innerHTML =
          '<p class="text-sm text-slate-500">ã“ã®ç‰©ä»¶ã®å…¥å±…ã®ã—ãŠã‚Šã¯æº–å‚™ä¸­ã§ã™ã€‚</p>';
      }
    }

    main();
  </script>
</body>
</html>
