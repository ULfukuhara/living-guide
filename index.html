<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入居のしおり | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* リッチテキストの基本整形 */
    .richtext p { margin-bottom: 0.6rem; }
    .richtext ul { margin-left: 1.4rem; margin-bottom: 0.6rem; list-style: disc; }
    .richtext ol { margin-left: 1.4rem; margin-bottom: 0.6rem; list-style: decimal; }
    .richtext a { text-decoration: underline; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">UL</span>
        <div>
          <p class="text-xs text-slate-500">UniLife 入居者専用</p>
          <h1 class="text-base sm:text-lg font-semibold text-slate-800" id="propertyTitle">
            物件名を読み込み中…
          </h1>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-4 pt-4 pb-12 space-y-6">

      <!-- 物件情報 -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 space-y-2">
        <p id="propertyMeta" class="text-[11px] text-slate-400">情報を取得中</p>
        <p class="text-[11px] text-slate-400">
          ※ 内容は物件により異なります
        </p>
      </section>

      <!-- タブ -->
      <section class="mt-2">
        <div id="tabNav" class="flex gap-2 overflow-x-auto pb-1 text-sm"></div>
        <div id="tabPanels" class="mt-3 space-y-4"></div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-200 bg-white">
    <div class="max-w-4xl mx-auto px-4 py-3 text-[11px] text-slate-400 flex justify-between">
      <p>© UniLife</p>
      <p>Storyblok + Firestore Web Guide</p>
    </div>
  </footer>

  <!-- ========================================================== -->
  <!-- Storyblok連携（Sections でタブを自動生成）               -->
  <!-- ========================================================== -->

  <script>
    /* ---------------------------------------------------------
     * 設定
     * --------------------------------------------------------- */
    const STORYBLOK_TOKEN = "sdvg2FfGE4TIQ6wTLIJItQtt";  // ←変更してください

    // URLから propertyNo を取得
    function getPropertyNoFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const no = params.get("propertyNo");
      return no || "demo";
    }

    /* ---------------------------------------------------------
     * Storyblok APIでGuideデータ取得
     * --------------------------------------------------------- */
    async function fetchGuideStory(propertyNo) {
      const slug = propertyNo; // スラッグがそのまま propertyNo の場合

      const url =
        "https://api.storyblok.com/v2/cdn/stories/" +
        encodeURIComponent(slug) +
        "?token=" +
        encodeURIComponent(STORYBLOK_TOKEN) +
        "&version=published";

      const res = await fetch(url);
      if (!res.ok) throw new Error("Storyblok API Error: " + res.status);

      const data = await res.json();
      return data.story;
    }

    /* ---------------------------------------------------------
     * Richtext（簡易変換）
     * --------------------------------------------------------- */
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderTextNode(node) {
      if (!node) return "";
      if (node.type === "text") {
        let text = escapeHtml(node.text || "");
        if (node.marks) {
          node.marks.forEach((mark) => {
            if (mark.type === "bold") text = "<strong>" + text + "</strong>";
            if (mark.type === "italic") text = "<em>" + text + "</em>";
            if (mark.type === "link" && mark.attrs?.href) {
              text =
                `<a href="${escapeHtml(mark.attrs.href)}"
                    class="text-sky-600 underline"
                    target="_blank"
                    rel="noopener">${text}</a>`;
            }
          });
        }
        return text;
      }
      if (node.type === "hard_break") return "<br/>";
      return "";
    }

    function renderRichText(node) {
      if (!node || !node.content) return "";
      return node.content
        .map((child) => {
          switch (child.type) {
            case "paragraph":
              return `<p>${(child.content || [])
                .map(renderTextNode)
                .join("")}</p>`;

            case "bullet_list":
              return (
                "<ul>" +
                (child.content || [])
                  .map((li) => {
                    const t = (li.content || [])
                      .map(renderTextNode)
                      .join("");
                    return `<li>${t}</li>`;
                  })
                  .join("") +
                "</ul>"
              );

            case "ordered_list":
              return (
                "<ol>" +
                (child.content || [])
                  .map((li) => {
                    const t = (li.content || [])
                      .map(renderTextNode)
                      .join("");
                    return `<li>${t}</li>`;
                  })
                  .join("") +
                "</ol>"
              );

            default:
              return "";
          }
        })
        .join("");
    }

    /* ---------------------------------------------------------
     * 画面描画
     * --------------------------------------------------------- */
    function renderGuidePage(story) {
      const content = story.content || {};
      const sections = content.sections || [];

      // タイトル設定
      const titleEl = document.getElementById("propertyTitle");
      if (titleEl) titleEl.textContent = content.title || story.name;

      // propertyNo 表示
      const metaEl = document.getElementById("propertyMeta");
      if (metaEl) metaEl.textContent = content.propertyNo
        ? "物件No. " + content.propertyNo
        : "";

      const tabNav = document.getElementById("tabNav");
      const tabPanels = document.getElementById("tabPanels");
      tabNav.innerHTML = "";
      tabPanels.innerHTML = "";

      if (!sections.length) {
        tabPanels.innerHTML =
          '<p class="text-sm text-slate-500">この物件の入居のしおりは準備中です。</p>';
        return;
      }

      sections.forEach((sec, index) => {
        const key = sec.key || sec._uid || "sec" + index;
        const icon = sec.icon || "";
        const title = sec.title || "セクション";
        const showTab = sec.show_tab !== false;
        const isActive = index === 0;

        // ▼タブ
        if (showTab) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.dataset.tab = key;
          btn.className =
            "tab-btn px-3 py-1.5 rounded-full whitespace-nowrap text-xs sm:text-sm " +
            (isActive ? "bg-slate-900 text-white" : "bg-slate-100 text-slate-700");

          btn.innerHTML =
            (icon ? `<span>${icon}</span> ` : "") +
            `<span>${escapeHtml(title)}</span>`;

          tabNav.appendChild(btn);
        }

        // ▼本文パネル
        const panel = document.createElement("section");
        panel.dataset.tabPanel = key;
        panel.className =
          "tab-panel bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 " +
          (isActive ? "" : "hidden");

        const h3 = document.createElement("h3");
        h3.className =
          "text-base sm:text-lg font-semibold text-slate-900 flex items-center gap-2";
        h3.innerHTML =
          (icon ? `<span>${icon}</span> ` : "") +
          `<span>${escapeHtml(title)}</span>`;

        panel.appendChild(h3);

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "richtext mt-2 text-xs sm:text-sm text-slate-700 leading-relaxed";
        bodyDiv.innerHTML = renderRichText(sec.body);
        panel.appendChild(bodyDiv);

        if (sec.note) {
          const noteP = document.createElement("p");
          noteP.className = "mt-2 text-[11px] text-slate-400";
          noteP.textContent = sec.note;
          panel.appendChild(noteP);
        }

        tabPanels.appendChild(panel);
      });

      setupTabBehavior();
    }

    /* ---------------------------------------------------------
     * タブ切り替え
     * --------------------------------------------------------- */
    function setupTabBehavior() {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;

          tabButtons.forEach((b) => {
            const active = b === btn;
            b.classList.toggle("bg-slate-900", active);
            b.classList.toggle("text-white", active);
            b.classList.toggle("bg-slate-100", !active);
            b.classList.toggle("text-slate-700", !active);
          });

          tabPanels.forEach((panel) => {
            panel.classList.toggle("hidden", panel.dataset.tabPanel !== target);
          });

          const firstPanel = tabPanels[0];
          if (firstPanel) {
            const rect = firstPanel.getBoundingClientRect();
            const top = window.scrollY + rect.top - 80;
            window.scrollTo({ top, behavior: "smooth" });
          }
        });
      });
    }

    /* ---------------------------------------------------------
     * メイン処理
     * --------------------------------------------------------- */
    async function main() {
      const propertyNo = getPropertyNoFromUrl();
      try {  
        const story = await fetchGuideStory(propertyNo);
        renderGuidePage(story);
      } catch (e) {
        console.error(e);
        const tabPanels = document.getElementById("tabPanels");
        if (tabPanels) {
          tabPanels.innerHTML =
            '<p class="text-sm text-rose-600">データの読み込みに失敗しました。</p>';
        }
      }
    }

    document.addEventListener("DOMContentLoaded", main);
  </script>

</body>
</html>
