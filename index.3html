<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入居のしおり | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 id="propertyTitle" class="text-lg font-semibold text-slate-800">
          物件名を読み込み中…
        </h1>
        <p id="propertyNo" class="text-xs text-slate-500"></p>
      </div>
      <span class="text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700">
        入居のしおり
      </span>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 max-w-3xl mx-auto w-full px-4 py-6 space-y-4">

    <!-- ▼ 物件概要（Property Guide > Overview の内容） -->
    <section id="overviewSection" class="hidden bg-white rounded-xl shadow-sm p-4 space-y-2">
      <h2 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
        <span class="w-1.5 h-4 rounded-full bg-slate-400 inline-block"></span>
        物件概要
      </h2>

      <dl class="grid grid-cols-[90px,1fr] gap-y-1 gap-x-2 text-sm text-slate-700">
        <dt class="font-semibold text-slate-500">物件名</dt>
        <dd id="ov-title"></dd>

        <dt class="font-semibold text-slate-500">住所</dt>
        <dd id="ov-address"></dd>

        <dt class="font-semibold text-slate-500">エリア</dt>
        <dd id="ov-area"></dd>

        <dt class="font-semibold text-slate-500">築年</dt>
        <dd id="ov-built-year"></dd>
      </dl>

      <div id="ov-description" class="text-sm text-slate-700 whitespace-pre-wrap"></div>
    </section>

    <!-- ▼ インターネット・TV -->
    <section id="internetSection" class="hidden bg-white rounded-xl shadow-sm p-4 space-y-1">
      <h2 class="text-sm font-semibold text-indigo-700 flex items-center gap-2">
        <span class="w-1.5 h-4 rounded-full bg-indigo-400 inline-block"></span>
        インターネット・TV
      </h2>
      <p id="internet" class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
    </section>

    <!-- ▼ ごみ出し -->
    <section id="trashSection" class="hidden bg-white rounded-xl shadow-sm p-4 space-y-1">
      <h2 class="text-sm font-semibold text-amber-700 flex items-center gap-2">
        <span class="w-1.5 h-4 rounded-full bg-amber-400 inline-block"></span>
        ごみ出しについて
      </h2>
      <p id="trash" class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
    </section>

    <!-- ▼ 駐輪場 -->
    <section id="bicycleSection" class="hidden bg-white rounded-xl shadow-sm p-4 space-y-1">
      <h2 class="text-sm font-semibold text-emerald-700 flex items-center gap-2">
        <span class="w-1.5 h-4 rounded-full bg-emerald-400 inline-block"></span>
        駐輪場について
      </h2>
      <p id="bicycle" class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
    </section>

    <!-- ▼ その他 -->
    <section id="otherSection" class="hidden bg-white rounded-xl shadow-sm p-4 space-y-1">
      <h2 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
        <span class="w-1.5 h-4 rounded-full bg-slate-400 inline-block"></span>
        その他のルール・お願い
      </h2>
      <p id="other" class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
    </section>

    <!-- ▼ 連絡先 -->
    <section id="contactSection" class="hidden bg-white rounded-xl shadow-sm p-4 space-y-1">
      <h2 class="text-sm font-semibold text-rose-700 flex items-center gap-2">
        <span class="w-1.5 h-4 rounded-full bg-rose-400 inline-block"></span>
        連絡先
      </h2>
      <div class="text-sm text-slate-700 space-y-1">
        <p>管理会社：<span id="management_contact" class="font-medium"></span></p>
        <p>緊急時連絡先：<span id="emergency_contact" class="font-medium"></span></p>
      </div>
    </section>

    <p id="status" class="text-xs text-slate-500">
      Storyblok からデータを取得しています…
    </p>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-3 text-xs text-slate-500 text-center">
      &copy; <span id="year"></span> ユニヴ・ライフ株式会社 管理部
    </div>
  </footer>

  <script>
    // ===== 設定 =====
    // そのまま貼ってもOKですが、必要なら他の Space に変えたときに差し替えてください
    const STORYBLOK_TOKEN = "ir2Hm2c38mI69te9Vr92RAtt";
    const DEFAULT_SLUG = "demo-guide"; // propertyNo パラメータが無いとき用

    document.getElementById("year").textContent = new Date().getFullYear();

    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function showSection(idPrefix, text) {
      if (text) {
        document.getElementById(idPrefix).textContent = text;
        document.getElementById(idPrefix + "Section").classList.remove("hidden");
      }
    }

    async function main() {
      const propertyNo = getParam("propertyNo") || DEFAULT_SLUG;
      document.getElementById("propertyNo").textContent = "物件No：" + propertyNo;

      try {
        const url = new URL("https://api.storyblok.com/v2/cdn/stories/" + propertyNo);
        url.searchParams.set("token", STORYBLOK_TOKEN);
        url.searchParams.set("version", "published");
        url.searchParams.set("cv", Date.now().toString());

        const res = await fetch(url.toString());
        if (!res.ok) throw new Error("Storyblok API エラー: " + res.status);

        const data = await res.json();

        // ===== content / overview の取り出し =====
        const content = data.story?.content;
        if (!content) throw new Error("該当する物件情報が見つかりません");

        // content.overview（Overview ブロック）があればそれを優先
        let overview = content.overview || null;

        // 万が一 body 配列に Overview が入っているパターンにも対応
        if (!overview && Array.isArray(content.body)) {
          overview = content.body.find(
            (b) => (b.component || "").toLowerCase().includes("overview")
          );
        }

        // どちらも無ければ content 自体を overview とみなす
        if (!overview) overview = content;

        // ===== ヘッダーのタイトル =====
        document.getElementById("propertyTitle").textContent =
          overview.title || content.title || data.story.name || propertyNo;

        // ===== 物件概要 =====
        document.getElementById("ov-title").textContent =
          overview.title || "";
        document.getElementById("ov-address").textContent =
          overview.address || "";
        document.getElementById("ov-area").textContent =
          overview.area || "";
        document.getElementById("ov-built-year").textContent =
          overview.built_year || overview.builtYear || "";

        // Description / Text をまとめて説明として表示
        const descParts = [];
        if (overview.description) descParts.push(overview.description);
        if (overview.text) descParts.push(overview.text);
        if (descParts.length > 0) {
          document.getElementById("ov-description").textContent =
            descParts.join("\n\n");
        }

        // 何かしら概要があればセクション表示
        if (
          overview.title ||
          overview.address ||
          overview.area ||
          overview.built_year ||
          overview.description ||
          overview.text
        ) {
          document.getElementById("overviewSection").classList.remove("hidden");
        }

        // ===== ルール系（今後フィールドを増やしたとき用） =====
        showSection("internet", content.internet);
        showSection("trash", content.trash);
        showSection("bicycle", content.bicycle);
        showSection("other", content.other);

        if (content.management_contact || content.emergency_contact) {
          if (content.management_contact)
            document.getElementById("management_contact").textContent =
              content.management_contact;
          if (content.emergency_contact)
            document.getElementById("emergency_contact").textContent =
              content.emergency_contact;
          document
            .getElementById("contactSection")
            .classList.remove("hidden");
        }

        document.getElementById("status").textContent =
          "最新のデータを表示しています。";
      } catch (e) {
        console.error(e);
        const status = document.getElementById("status");
        status.textContent = "データ取得に失敗しました：" + e.message;
        status.classList.add("text-red-600");
      }
    }

    main();
  </script>
</body>
</html>
