<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入居のしおり | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 id="propertyTitle" class="text-lg font-semibold text-slate-800">
          物件名を読み込み中…
        </h1>
        <p id="propertyMeta" class="text-xs text-slate-500">
          物件情報を取得しています…
        </p>
      </div>
      <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
        入居のしおり
      </span>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6">

      <!-- ローディング -->
      <div id="loading" class="mb-4">
        <p class="text-sm text-slate-600 bg-slate-50 border border-slate-200 rounded-md px-3 py-2">
          最新のデータを読み込み中です…
        </p>
      </div>

      <!-- お知らせ -->
      <div id="notice" class="mb-4 hidden">
        <p id="noticeText"
          class="text-sm text-amber-700 bg-amber-50 border border-amber-100 rounded-md px-3 py-2"></p>
      </div>

      <!-- セクション -->
      <div id="sectionsContainer" class="space-y-4"></div>

      <p class="mt-8 text-[11px] text-slate-400 text-right">
        ※ 記載内容は予告なく変更される場合があります。最新情報は管理会社までお問い合わせください。
      </p>
    </div>
  </main>

  <!-- Firebase + Firestore ロジック -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDneH08GavPizbtH4Oi-RsTrwGerxXWSyQ",
      authDomain: "univlife-kanri.firebaseapp.com",
      projectId: "univlife-kanri",
      storageBucket: "univlife-kanri.firebasestorage.app",
      messagingSenderId: "405011982427",
      appId: "1:405011982427:web:cf56a37550ab714bfdb77e",
      measurementId: "G-DXMR0VL972"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function flagOn(v) {
      return v === true || v === "TRUE" || v === "true" || v === 1 || v === "1";
    }

    function getSlug() {
      let path = window.location.pathname.replace(/^\/+|\/+$/g, "");
      if (path) return path;

      const params = new URLSearchParams(window.location.search);
      const fromQuery = params.get("propertyNo");
      if (fromQuery) return fromQuery;

      return "10100";
    }

    async function loadPropertyBySlug(slug) {
      const colRef = collection(db, "properties_shiori");
      const q = query(colRef, where("shiori_slug", "==", slug));
      const snap = await getDocs(q);
      if (snap.empty) return null;
      const doc = snap.docs[0];
      return { doc_id: doc.id, ...doc.data() };
    }

    async function loadGuidesMaster() {
      const colRef = collection(db, "guides_master");
      const snap = await getDocs(colRef);
      const guides = {};
      snap.forEach(doc => {
        const data = doc.data();
        const key = data.section_key || doc.id;
        guides[key] = data;
      });
      return guides;
    }

    const SECTION_DEFS = [
      { key: "key",            title: "鍵" },
      { key: "mailbox",        title: "メールBOX" },
      { key: "delivery_box",   title: "宅配ボックス" },
      { key: "bicycle_space",  title: "自転車区画" },
      { key: "room_equipment", title: "室内設備" },
      { key: "moving",         title: "引っ越し" },
      { key: "electricity",    title: "電気" },
      { key: "gas",            title: "ガス" },
      { key: "water",          title: "水道" },
      { key: "internet",       title: "インターネット" },
      { key: "trash",          title: "ゴミ" },
      { key: "common_area",    title: "共用部の使用" },
      { key: "pets",           title: "ペットの飼育" },
      { key: "toilet",         title: "トイレの使用" },
      { key: "noise",          title: "騒音" },
      { key: "drainage",       title: "排水" },
      { key: "ventilation",    title: "換気" },
      { key: "heater",         title: "暖房器具" },
      { key: "bike_parking",   title: "駐輪場" },
      { key: "car_parking",    title: "駐車場" },
      { key: "sales",          title: "訪問販売" },
      { key: "expenses",       title: "入居中の費用負担" },
      { key: "cancellation",   title: "解約" },
    ];

    function renderSections(propertyData, guidesMaster) {
      const container = document.getElementById("sectionsContainer");
      container.innerHTML = "";

      SECTION_DEFS.forEach(section => {
        if (!flagOn(propertyData[section.key])) return;

        const guide = guidesMaster[section.key] || {};
        const bodies = guide.bodies || {};

        const parts = [];
        if (bodies.base) {
          parts.push(bodies.base);
        }

        const variantField = section.key + "_variant";
        const variantKey = propertyData[variantField];

        if (variantKey && bodies[variantKey]) {
          parts.push(bodies[variantKey]);
        }

        const bodyHtml = parts.length > 0
          ? parts.join("<br><br>")
          : "この項目の説明文は現在準備中です。";

        const sec = document.createElement("section");
        sec.className =
          "bg-white rounded-xl shadow-sm border border-slate-100 px-4 py-3";
        sec.id = section.key;

        sec.innerHTML = `
          <h2 class="text-base font-semibold text-slate-800 mb-1">${section.title}</h2>
          <div class="text-sm text-slate-700 leading-relaxed">
            ${bodyHtml}
          </div>
        `;

        container.appendChild(sec);
      });

      if (propertyData.special_note) {
        const sec = document.createElement("section");
        sec.className =
          "bg-amber-50 rounded-xl border border-amber-100 px-4 py-3";
        sec.id = "special_note";
        sec.innerHTML = `
          <h2 class="text-base font-semibold text-amber-800 mb-1">特記事項</h2>
          <div class="text-sm text-amber-900 leading-relaxed">
            ${propertyData.special_note}
          </div>
        `;
        container.appendChild(sec);
      }
    }

    async function init() {
      const slug = getSlug();

      const titleEl = document.getElementById("propertyTitle");
      const metaEl = document.getElementById("propertyMeta");
      const noticeEl = document.getElementById("notice");
      const noticeTextEl = document.getElementById("noticeText");
      const loadingEl = document.getElementById("loading");

      try {
        const [propertyData, guidesMaster] = await Promise.all([
          loadPropertyBySlug(slug),
          loadGuidesMaster(),
        ]);

        loadingEl.classList.add("hidden");

        if (!propertyData) {
          titleEl.textContent = "物件が見つかりません";
          metaEl.textContent = `指定された物件番号（slug）: ${slug}`;
          noticeEl.classList.remove("hidden");
          noticeTextEl.textContent = "URL の物件番号が正しいかご確認ください。";
          return;
        }

        titleEl.textContent =
          propertyData.canonicalName || propertyData.propertyNo || slug;
        metaEl.textContent =
          `物件No: ${propertyData.propertyNo || "-"} ／ ${propertyData.address || ""}`;

        if (!flagOn(propertyData.shiori_enabled)) {
          noticeEl.classList.remove("hidden");
          noticeTextEl.textContent =
            "この物件の「入居のしおり」は現在公開されていません。";
          return;
        }

        renderSections(propertyData, guidesMaster);
      } catch (err) {
        console.error(err);
        loadingEl.classList.add("hidden");
        titleEl.textContent = "読み込みエラー";
        metaEl.textContent = "";
        noticeEl.classList.remove("hidden");
        noticeTextEl.textContent =
          "データの読み込みに失敗しました。時間をおいて再度お試しください。";
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
