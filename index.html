<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å…¥å±…ã®ã—ãŠã‚Š | guide.univ-life.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

  <!-- ========= Header ========= -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-3xl mx-auto px-4 py-4 space-y-1">
      <!-- ç‰©ä»¶å -->
      <h1 id="propertyTitle" class="text-lg font-semibold text-slate-800">
        å…¥å±…ã®ã—ãŠã‚Šã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
      </h1>

      <!-- ç‰©ä»¶No -->
      <p id="propertyNo" class="text-xs text-slate-500"></p>

      <!-- ç‰©ä»¶æƒ…å ±ï¼šéƒµä¾¿ç•ªå·ï¼ä½æ‰€ -->
      <div id="propertyInfo" class="text-xs text-slate-700 leading-relaxed"></div>
    </div>
  </header>

  <!-- ========= Main ========= -->
  <main class="flex-1">
    <div class="max-w-3xl mx-auto px-4 py-6 space-y-6">
      <div id="guideBody" class="space-y-6"></div>
    </div>
  </main>

  <!-- ========= Footer ========= -->
  <footer class="border-t border-slate-200 bg-white">
    <div class="max-w-3xl mx-auto px-4 py-3">
      <p class="text-[10px] text-slate-400">Â© ãƒ¦ãƒ‹ãƒ´ãƒ»ãƒ©ã‚¤ãƒ•æ ªå¼ä¼šç¤¾ ç®¡ç†éƒ¨</p>
    </div>
  </footer>

  <!-- ========= Script ========= -->
  <script>
    // ======================
    // è¨­å®š
    // ======================
    const STORYBLOK_TOKEN   = "sdvg2FfGE4TIQ6wTLIJItQtt";
    const STORYBLOK_VERSION = "published";

    const titleEl  = document.getElementById("propertyTitle");
    const noEl     = document.getElementById("propertyNo");
    const infoEl   = document.getElementById("propertyInfo");
    const bodyEl   = document.getElementById("guideBody");

    // ğŸ”¹ ç‰©ä»¶ãƒã‚¹ã‚¿ï¼ˆã„ã£ãŸã‚“ã“ã“ã«ç›´æ›¸ãï¼‰
    //   å°†æ¥ã“ã“ã‚’ Firestore ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã—ã¦ã‚‚OK
    const PROPERTY_MASTER = {
      "10100": {
        name: "å°šå¿—ãƒã‚¦ã‚¹",
        postalCode: "536-0006",
        address: "å¤§é˜ªåºœå¤§é˜ªå¸‚åŸæ±åŒºé‡æ±Ÿ4-4-3"
      }
      // 10200 ä»¥é™ã¯ã“ã“ã«è¿½åŠ ã—ã¦ã„ãã‚¤ãƒ¡ãƒ¼ã‚¸
      // "10200": { ... }
    };

    // ======================
    // URL ã‹ã‚‰ propertyNo ã‚’å–å¾—
    // ======================
    function getPropertyNoFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return (params.get("propertyNo") || "10100").trim();
    }

    const propertyNo = getPropertyNoFromUrl();
    noEl.textContent = `ç‰©ä»¶Noï¼š${propertyNo}`;

    // ======================
    // ç‰©ä»¶ãƒã‚¹ã‚¿ã‚’ç”»é¢ã«åæ˜ 
    // ======================
    function applyPropertyInfo() {
      const info = PROPERTY_MASTER[propertyNo];

      if (!info) {
        // ãƒã‚¹ã‚¿ã«å®šç¾©ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆStoryblok ã‚¿ã‚¤ãƒˆãƒ«ã ã‘ã§è¡¨ç¤ºï¼‰
        return;
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç‰©ä»¶åï¼‹ç‰©ä»¶Noï¼‰
      if (info.name) {
        titleEl.textContent = `${info.name}ï¼ˆ${propertyNo}ï¼‰`;
      }

      // éƒµä¾¿ç•ªå·ï¼‹ä½æ‰€
      const lines = [];
      if (info.postalCode) {
        lines.push(`ã€’${info.postalCode}`);
      }
      if (info.address) {
        lines.push(info.address);
      }
      infoEl.innerHTML = lines.join("<br>");
    }

    // ======================
    // Storyblok ã‹ã‚‰ guide_page ã‚’å–å¾—
    // ======================
    async function loadGuideFromStoryblok() {
      const apiUrl =
        "https://api.storyblok.com/v2/cdn/stories" +
        `?token=${STORYBLOK_TOKEN}` +
        `&version=${STORYBLOK_VERSION}` +
        `&per_page=100&page=1`;

      try {
        const res = await fetch(apiUrl);
        if (!res.ok) {
          throw new Error(`Storyblok error: ${res.status} ${res.statusText}`);
        }

        const data = await res.json();
        const stories = data.stories || [];

        const story = stories.find(
          (s) => s.slug === propertyNo || s.full_slug === propertyNo
        );

        if (!story) {
          showError("è©²å½“ã™ã‚‹å…¥å±…ã®ã—ãŠã‚ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }

        const content = story.content || {};

        // ç‰©ä»¶ãƒã‚¹ã‚¿ã§ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥ã£ã¦ã„ãªã„å ´åˆã ã‘ Storyblok ã® title ã‚’ä½¿ã†
        if (
          !titleEl.textContent ||
          titleEl.textContent === "å…¥å±…ã®ã—ãŠã‚Šã‚’èª­ã¿è¾¼ã¿ä¸­â€¦"
        ) {
          titleEl.textContent =
            content.title || story.name || `å…¥å±…ã®ã—ãŠã‚Šï¼ˆ${propertyNo}ï¼‰`;
        }

        renderSections(content.sections || []);

      } catch (err) {
        console.error(err);
        showError("å…¥å±…ã®ã—ãŠã‚Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    // ======================
    // sections ã‚’æç”»
    // ======================
    function renderSections(sections) {
      bodyEl.innerHTML = "";

      if (!sections || !sections.length) {
        bodyEl.innerHTML =
          '<p class="text-sm text-slate-500">å…¥å±…ã®ã—ãŠã‚Šã®å†…å®¹ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
        return;
      }

      sections.forEach((sec) => {
        if (!sec) return;

        const wrapper = document.createElement("section");
        wrapper.className =
          "rounded-lg bg-white p-5 shadow-sm space-y-3 border border-slate-200";

        const h2 = document.createElement("h2");
        h2.className = "text-lg font-semibold text-slate-800 border-b border-slate-300 pb-1";
        h2.textContent = sec.headline || "";
        wrapper.appendChild(h2);

        const bodyHTML = richtextToHtml(sec.body);
        const bodyDiv = document.createElement("div");
        bodyDiv.className = "prose prose-sm max-w-none text-slate-800";
        bodyDiv.innerHTML = bodyHTML;

        wrapper.appendChild(bodyDiv);
        bodyEl.appendChild(wrapper);
      });
    }

    // ======================
    // Storyblok Richtext â†’ HTML
    // ======================
    function richtextToHtml(rich) {
      if (!rich || !Array.isArray(rich.content)) return "";

      let html = "";

      rich.content.forEach((node) => {
        if (node.type === "paragraph") {
          let line = "";

          (node.content || []).forEach((child) => {
            if (child.type === "text") {
              line += child.text.replace(/\n/g, "<br>");
            }
            if (child.type === "link") {
              const href = child.attrs?.href || "#";
              const text =
                (child.content && child.content[0] && child.content[0].text) ||
                href;
              line += `<a href="${href}" class="text-blue-600 underline" target="_blank" rel="noopener noreferrer">${text}</a>`;
            }
          });

          html += `<p>${line}</p>`;
        }
      });

      return html;
    }

    // ======================
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    // ======================
    function showError(message) {
      bodyEl.innerHTML = `
        <p class="text-sm text-red-600">${message}</p>
        <p class="text-xs text-slate-500 mt-2">
          ãŠæ‰‹æ•°ã§ã™ãŒã€ç®¡ç†ä¼šç¤¾ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚
        </p>
      `;
    }

    // ======================
    // å®Ÿè¡Œ
    // ======================
    (async () => {
      applyPropertyInfo();       // ã¾ãšç‰©ä»¶åï¼ä½æ‰€ã‚’åæ˜ 
      await loadGuideFromStoryblok(); // ãã®å¾Œã« Storyblok æœ¬æ–‡ã‚’èª­ã¿è¾¼ã¿
    })();
  </script>
</body>
</html>
